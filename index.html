<!DOCTYPE html>
<!-- saved from url=(0051)file:///C:/Users/despo/Downloads/index_updated.html -->
<html lang="fr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <title>IA Gestion Entreprise Béta</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    .tabs {
      background: #d6d6d6;
      display: flex;
      border-bottom: 2px solid lightskyblue;
    }
    .tabs div {
      padding: 10px 20px;
      border-right: 1px solid lightskyblue;
      font-weight: bold;
      cursor: pointer;
      color: black
    }
    .main {
      display: flex;
      height: calc(100vh - 50px);
    }
    .content {
      flex: 1;
      padding: 20px;
    }

    .form-group {
      margin-bottom: 10px;
    }
    .form-group label {
      display: block;
      margin-bottom: 4px;
      font-size: 14px;
    }
    .form-group input {
      width: 100%;
      padding: 6px;
      border: 1px solid #999;
    }
    .footer {
      display: flex;
      justify-content: space-between;
      background: #d6d6d6;
      padding: 10px;
      border-top: 2px solid #999;
    }
    .footer button {
      padding: 10px 20px;
      border: none;
      background: #bbb;
      cursor: pointer;
    }
     #client-options, #nouveau-client-form, #recherche-client-form, #resultatsRecherche, #interface-pieces, #accueil-section, #nouveau-piece-form, #recherche-piece-form, #resultats-recherche-pieces, #facture-options, #nouvelle-facture-form, #interface-maindoeuvre, #nouveau-maindoeuvre-form, #recherche-maindoeuvre-form, #resultats-recherche-maindoeuvre {
      display: none;
    }
       /* NOUVEAU: Style pour la section d'accueil avec image de fond */
    #accueil-section {
      position: relative; /* Nécessaire pour positionner le voile sombre */
      height: 100%; /* Prend toute la hauteur disponible */
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;          /* pour que le texte soit centré */
      padding: 2rem 1rem;          /* espacement interne */
      max-width: 1200px;           /* pour limiter la largeur si besoin */
      margin: 0 auto 2rem; 
      background-repeat: no-repeat; /* Empêche l'image de se répéter */
      background-position: center; /* L'image est centrée */
   /* Le voile sombre et le texte blanc ont été retirés, car ils ne sont plus nécessaires. */
    }
    .client-card {
      background: white;
      border: 1px solid #ccc;
      margin-bottom: 10px;
      padding: 10px;
    }
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    .modal-content {
        background: white;
        padding: 20px;
        border-radius: 5px;
        width: 500px;
        max-height: 80vh;
        overflow-y: auto;
    }
    .resultat-recherche-facture-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; }
    .resultat-recherche-facture-item:hover { background-color: #f0f0f0; }
    #nouvelle-facture-form {
        background: white;
        padding: 20px;
        border: 1px solid #ddd;
    }
    .facture-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #333;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    .facture-client-section, .facture-lignes-section, .facture-notes-section, .facture-totaux-section, .facture-actions {
        margin-bottom: 20px;
    }
    #facture-lignes-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 10px;
    }
    #facture-lignes-table th, #facture-lignes-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }
    #facture-lignes-table th {
        background-color: #f2f2f2;
    }
    .facture-totaux-section {
        width: 300px;
        margin-left: auto;
        padding: 10px;
        border: 1px solid #ccc;
        background: #f9f9f9;
    }
    .total-ligne {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }
    .total-final {
        font-weight: bold;
        font-size: 1.2em;
        border-top: 1px solid #999;
        padding-top: 5px;
    }
    #facture-resultats-recherche-client .resultat-client { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; }
    #facture-resultats-recherche-client .resultat-client:hover { background-color: #f0f0f0; }
    .facture-search-container {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    .facture-search-container input {
        flex-grow: 1;
    }
    #facture-infos-complementaires { width: 100%; padding: 6px; border: 1px solid #999; }
  </style>
  <!-- NOUVEAU: Styles pour la recherche de pièces en direct dans la facture -->
  <style>
    .search-container-cell {
        position: relative; /* Essentiel pour positionner les résultats */
    }
    .search-results {
        display: none; /* Caché par défaut */
        position: absolute;
        top: 100%; /* S'affiche juste en dessous du champ de recherche */
        left: 0;
        right: 0;
        background-color: white;
        border: 1px solid #ccc;
        border-top: none;
        z-index: 1000; /* S'assure que la liste est au-dessus des autres éléments */
        max-height: 200px;
        overflow-y: auto;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        text-align: left; /* Aligner le texte à gauche dans les résultats */
    }
    .result-item {
        padding: 8px 12px;
        cursor: pointer;
    }
    .result-item:hover {
        background-color: #f0f0f0;
    }
    .result-item-error {
        padding: 8px 12px;
        color: #dc3545;
    }
    .description-search-input {
        width: 100%;
        box-sizing: border-box;
    }
  </style>
  <style>
    /* Styles généraux pour les formulaires et les groupes */
    .form-group {
      margin-bottom: 10px;
    }
    .form-group label {
      display: block;
      margin-bottom: 4px;
      font-size: 14px;
    }
    .form-group input, .form-group textarea {
      width: 100%;
      padding: 6px;
      border: 1px solid #999;
      box-sizing: border-box; /* Inclut le padding et la bordure dans la largeur */
    }

    /* Styles pour la vue calendrier hebdomadaire */
    .planning-calendar-header {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 10px;
        background-color: #e0e0e0;
        border-bottom: 1px solid #ccc;
        margin-bottom: 10px;
    }

    .planning-calendar-grid {
        display: grid;
        /* 1 colonne pour les heures, 7 pour les jours */
        grid-template-columns: 60px repeat(7, 1fr);
        grid-auto-rows: minmax(40px, auto); /* Hauteur minimale pour les cellules */
        border: 1px solid #ddd;
        background-color: #fff;
    }

    .calendar-grid-cell, .calendar-day-header, .calendar-time-label {
        border: 1px solid #eee;
        padding: 5px;
        box-sizing: border-box;
        text-align: center;
    }

    .calendar-day-header {
        background-color: #f0f0f0;
        font-weight: bold;
        padding: 10px 5px;
    }

    .calendar-time-label {
        background-color: #f8f8f8;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9em;
    }

    .calendar-event-slot {
        background-color: #e6f7ff; /* Light blue for events */
        border-left: 3px solid #66b3ff; /* Darker blue border */
        margin: 2px;
        padding: 3px;
        font-size: 0.8em;
        text-align: left;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        cursor: pointer;
        border-radius: 3px;
    }
    .calendar-event-slot:hover {
        background-color: #cceeff;
    }
    /* NOUVEAU: Style de base pour tous les boutons pour un look cohérent */
    button {
        width: fit-content; /* Ajuste la largeur au contenu */
        padding: 8px 16px; /* Taille par défaut des boutons */
        font-size: 14px;   /* Taille de la police par défaut */
        border: 1px solid #767676;
        border-radius: 4px;
        background-color: #e0e0e0;
        color: #111; /* Couleur du texte sur les boutons */
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.2s, border-color 0.2s;
    }

    button:hover {
        background-color: #d5d5d5;
        border-color: #555;
    }
    /* --- Fin du style de base --- */
    h2 {
      color: #004a99; /* Couleur spécifique pour les titres de section */
      border-bottom: 1px solid #ccc;
      padding-bottom: 5px;
    }
    /* NOUVEAU: Styles pour le tableau de bord comptable */
    .dashboard-container {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }
    .dashboard-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        flex-grow: 1;
        text-align: center;
    }
    .dashboard-value {
        font-size: 2.5em;
        font-weight: bold;
        color: #007bff;
    }
    .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }
    .dashboard-widget {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .compta-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    .compta-table th, .compta-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }
    .compta-table th { background-color: #f2f2f2; }
  </style>
    <style>
      /* Styles pour la section Accueil planning et CA */
      #accueil-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 2rem 1rem;
        background: #f0f8ff;
        position: relative;
      }
      #accueil-section h2 {
        margin: 0 0 0.5rem;
        font-size: 2em;
        color: #004a99;
      }
      #date-heure-accueil {
        font-size: 1.2em;
        color: #333;
        margin-bottom: 1.5rem;
      }
      #visuels-accueil {
        display: flex;
        gap: 2rem;
        flex-wrap: wrap;
        justify-content: center;
       max-width: 1000px;
        margin:0 auto;
      }
      .card-accueil {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 1rem;
        flex: 1 1 300px;
        max-width: 480px;
        text-align: left;
      }
      .card-accueil h3 {
        margin-top: 0;
        font-size: 1.2em;
        color: #007bff;
        border-bottom: 1px solid #ccc;
        padding-bottom: 0.25rem;
      }
      .card-accueil .item {
        margin: 0.5rem 0;
      }
      .item-time {
        font-weight: bold;
        margin-right: 0.5rem;
      }
    </style>
</head>
<body>
  <div class="tabs"> 
    <div onclick="afficherAccueil()">F1 - Accueil</div> 
    <div onclick="afficherInterfaceFactures()">F2 - OR/Factures</div> 
    <div onclick="afficherOptionsClient()">F3 - Clients</div> 
    <div onclick="afficherInterfacePieces()">F4 - Pièces</div> 
    <div onclick="afficherInterfaceMaindoeuvre()">F5 - Main d'oeuvre</div> 
    <div onclick="afficherInterfaceAnalyse()">F6 - Analyse</div> 
    <div onclick="afficherInterfacePhotos()">F7 - Photos</div> 
    <div onclick="afficherInterfacePlanning()">F8 - Planning</div> 
    <div onclick="afficherInterfaceNotifications()">F9 - Notifications</div> 
    <div onclick="afficherInterfaceParametre()">F10 - Technicien</div> 
    <div onclick="afficherInterfaceOptions()">F11 - Option</div> 
    <div onclick="afficherInterfaceComptabilite()">Comptabilité</div> 

  </div>

    <div class="main">
    <div class="content">
        <!-- MODIFIÉ: Contenu de l'interface de comptabilité -->
        <div id="interface-comptabilite" style="display: none;">
            <h2>Tableau de Bord Comptable</h2>
            <button onclick="chargerDonneesComptabilite()">Rafraîchir les données</button>
            
            <div class="dashboard-container" style="margin-top: 20px;">
                <div class="dashboard-card">
                    <h3>Chiffre d'Affaires (Mois en cours)</h3>
                    <p id="ca-mois-total" class="dashboard-value">Chargement...</p>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-widget"><h3>Dépenses par Fournisseur (sur pièces facturées)</h3><div id="depenses-fournisseur-container">Chargement...</div></div>
                <div class="dashboard-widget"><h3>Chiffre d'Affaires par Famille de Pièces</h3><div id="ca-famille-piece-container">Chargement...</div></div>
            </div>
        </div>

      <div id="facture-options" style="display: none;">
        <h2>Facture</h2>
        <button onclick="afficherFormulaireNouvelleFacture()">Nouvelle facture</button>
        <button onclick="afficherFormulaireRechercheFacture()">Recherche de facture</button>
        <button id="btn-create-or" class="btn btn-primary" type="button">Création OR</button>
        <button id="btn-search-or" class="btn btn-secondary" type="button">Recherche d'OR</button>
      </div>
      
<!-- Modal de création d'Ordre de Réparation (OR) -->
    <div id="modal-create-or" class="modal-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;">
    <div class="modal-content" style="background:#fff; border-radius:8px; width:90%; max-width:800px; max-height:90vh; overflow-y:auto; padding:1.5rem; position:relative;">
        <button id="modal-close-create-or" style="position:absolute; top:1rem; right:1rem; font-size:1.5rem; background:none; border:none; cursor:pointer;">×</button>
    <h3>Ordre de Réparation - Carrosserie</h3>
        <form id="form-create-or">
      <!-- Informations client -->
        <fieldset style="margin-bottom:1rem;">
            <legend>Informations client</legend>
            <label>Nom complet:<br><input type="text" name="clientName" required="" style="width:100%;"></label><br>
            <label>Adresse:<br><input type="text" name="clientAddress" style="width:100%;"></label><br>
            <label>Téléphone:<br><input type="tel" name="clientPhone" style="width:100%;"></label><br>
            <label>Email:<br><input type="email" name="clientEmail" style="width:100%;"></label>
        </fieldset>
      <!-- Informations véhicule -->
      <fieldset style="margin-bottom:1rem;">
        <legend>Informations véhicule</legend>
        <label>Marque:<br><input type="text" name="vehicleMake" required="" style="width:100%;"></label><br>
        <label>Modèle:<br><input type="text" name="vehicleModel" required="" style="width:100%;"></label><br>
        <label>Année:<br><input type="number" name="vehicleYear" min="1900" max="2100" style="width:100px;"></label><br>
        <label>Immatriculation:<br><input type="text" name="licensePlate" style="width:100%;"></label><br>
        <label>VIN:<br><input type="text" name="vin" style="width:100%;"></label>
      </fieldset>
      <!-- Détails de dommages -->
      <fieldset style="margin-bottom:1rem;">
        <legend>Détails des dommages</legend>
        <label>Description des dommages:<br><textarea name="damageDescription" rows="3" style="width:100%;"></textarea></label><br>
        <label>Photos (URLs ou upload):<br><input type="text" name="damagePhotos" placeholder="Séparer par des virgules" style="width:100%;"></label>
      </fieldset>
      <!-- Liste des pièces -->
      <fieldset style="margin-bottom:1rem;">
        <legend>Pièces et fournitures</legend>
        <div id="parts-list">
          <div class="part-item" style="display:flex; gap:0.5rem; margin-bottom:0.5rem;">
            <input type="text" name="partName[]" placeholder="Nom pièce" style="flex:2;">
            <input type="number" name="partQty[]" placeholder="Qté" style="flex:1;">
            <input type="number" step="0.01" name="partCost[]" placeholder="Coût" style="flex:1;">
            <button type="button" class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">Suppr.</button>
          </div>
        </div>
        <button type="button" class="btn btn-sm btn-secondary" onclick="addPartRow()">Ajouter pièce</button>
      </fieldset>
      <!-- Main d'œuvre -->
      <fieldset style="margin-bottom:1rem;">
        <legend>Main d'œuvre</legend>
        <label>Description:<br><textarea name="laborDescription" rows="2" style="width:100%;"></textarea></label><br>
        <label>Heures estimées:<br><input type="number" step="0.1" name="laborHours" style="width:100px;"></label><br>
        <label>Taux horaire:<br><input type="number" step="0.01" name="laborRate" style="width:100px;"></label>
      </fieldset>
      <!-- Estimations et total -->
      <fieldset style="margin-bottom:1rem;">
        <legend>Estimations</legend>
        <label>Sous-total pièces:<br><input type="text" name="subtotalParts" readonly="" style="width:120px;"></label><br>
        <label>Coût main d'œuvre:<br><input type="text" name="subtotalLabor" readonly="" style="width:120px;"></label><br>
        <label>Total HT:<br><input type="text" name="totalHT" readonly="" style="width:120px;"></label><br>
        <label>TVA (%):<br><input type="number" name="vatRate" value="20" style="width:80px;"></label><br>
        <label>Total TTC:<br><input type="text" name="totalTTC" readonly="" style="width:120px;"></label>
      </fieldset>
      <!-- Validation -->
      <fieldset>
        <button type="submit" class="btn btn-success">Enregistrer OR</button>
        <button type="button" class="btn btn-secondary" id="btn-cancel-create-or">Annuler</button>
      </fieldset>
    </form>
  </div>
</div>

<style>
  /* Styles basiques pour le modal */
  .modal-overlay { display: none; }
  .modal-overlay.show { display: flex; }
</style>

<script>
  // Init F2 OR buttons et modal
  document.addEventListener('DOMContentLoaded', function() {
    var createBtn = document.getElementById('btn-create-or');
    var modal = document.getElementById('modal-create-or');
    var closeBtn = document.getElementById('modal-close-create-or');
    var cancelBtn = document.getElementById('btn-cancel-create-or');
    var form = document.getElementById('form-create-or');

    createBtn.addEventListener('click', openCreateOrModal);
    closeBtn.addEventListener('click', closeCreateOrModal);
    cancelBtn.addEventListener('click', closeCreateOrModal);

    form.addEventListener('submit', function(e) {
      e.preventDefault();
      // TODO: valider et envoyer les données
      console.log('OR enregistré', new FormData(form));
      closeCreateOrModal();
    });
  });

  function openCreateOrModal() {
    document.getElementById('modal-create-or').classList.add('show');
  }
  function closeCreateOrModal() {
    document.getElementById('modal-create-or').classList.remove('show');
  }

  function addPartRow() {
    var container = document.getElementById('parts-list');
    var row = document.createElement('div');
    row.className = 'part-item';
    row.style = 'display:flex; gap:0.5rem; margin-bottom:0.5rem;';
    row.innerHTML = '<input type="text" name="partName[]" placeholder="Nom pièce" style="flex:2;" />'
      + '<input type="number" name="partQty[]" placeholder="Qté" style="flex:1;" />'
      + '<input type="number" step="0.01" name="partCost[]" placeholder="Coût" style="flex:1;" />'
      + '<button type="button" class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">Suppr.</button>';
    container.appendChild(row);
  }
</script>

      <!-- NOUVEAUX BLOCS POUR LA RECHERCHE DE FACTURE -->
      <div id="recherche-facture-form" style="display: none;">
        <h2>Rechercher une facture</h2>
        <div class="form-group">
            <input type="text" id="recherche-facture-input" placeholder="Entrez un N° de facture, un nom de client...">
            <button onclick="rechercherFacture()">Rechercher</button>
        </div>
      </div>
      <div id="resultats-recherche-factures" style="display: none;"></div>

      <!-- MODAL/PANEL de recherche de CLIENT pour la facture -->
      <div id="recherche-client-facture-panel" class="modal-overlay" style="display: none;">
          <div class="modal-content">
              <h3>Résultats de la recherche client</h3>
              <div id="resultats-recherche-client-facture"></div>
              <button onclick="fermerRechercheClientFacture()">Fermer</button>
          </div>
      </div>

      <!-- MODAL/PANEL de recherche de pièce pour la facture -->
      <div id="recherche-piece-facture-panel" class="modal-overlay" style="display: none;">
          <div class="modal-content">
              <h3>Rechercher et ajouter une pièce</h3>
              <input type="text" id="recherche-piece-facture-input" onkeyup="rechercherPiecePourFacture()" placeholder="Rechercher par désignation ou référence...">
              <div id="resultats-recherche-piece-facture"></div>
              <button onclick="fermerRecherchePieceFacture()">Fermer</button>
          </div>
      </div>

       <!-- NOUVEAU: MODAL/PANEL de recherche de Main d'oeuvre pour la facture -->
      <div id="recherche-maindoeuvre-facture-panel" class="modal-overlay" style="display: none;">
          <div class="modal-content">
              <h3>Rechercher et ajouter de la Main d'oeuvre</h3>
              <input type="text" id="recherche-maindoeuvre-facture-input" onkeyup="rechercherMainDoeuvrePourFacture()" placeholder="Rechercher par description...">
              <div id="resultats-recherche-maindoeuvre-facture"></div>
              <button onclick="fermerRechercheMainDoeuvreFacture()">Fermer</button>
          </div>
      </div>

      <!-- NOUVEAU: MODAL/PANEL pour la modification d'un client -->
      <div id="edit-client-modal" class="modal-overlay" style="display: none;">
          <div class="modal-content">
              <h3>Modifier le client</h3>
              <input type="hidden" id="edit-client-id">
              <div class="form-group"><label for="edit-nom">Nom</label><input type="text" id="edit-nom"></div>
              <div class="form-group"><label for="edit-prenom">Prénom</label><input type="text" id="edit-prenom"></div>
              <div class="form-group"><label for="edit-telephone">Téléphone</label><input type="text" id="edit-telephone"></div>
              <div class="form-group"><label for="edit-email">Email</label><input type="email" id="edit-email"></div>
              <div class="form-group"><label for="edit-adresse">Adresse</label><input type="text" id="edit-adresse"></div>
              <div class="form-group"><label for="edit-code_postal">Code Postal</label><input type="text" id="edit-code_postal"></div>
              <div class="form-group"><label for="edit-ville">Ville</label><input type="text" id="edit-ville"></div>
              <div class="form-group"><label for="edit-pays">Pays</label><input type="text" id="edit-pays"></div>
              <button type="button" onclick="enregistrerModificationClient()">Sauvegarder</button>
              <button type="button" onclick="fermerModalModificationClient()">Annuler</button>
          </div>
      
      </div>

           <!-- NOUVEAU: Interface du Planning -->
      <div id="interface-planning" style="display: none;">
        <h2>Planning de la semaine</h2>
        <div class="planning-calendar-header">
            <button id="planning-prev-week">&lt; Semaine Précédente</button>
            <h3 id="planning-current-week"></h3>
            <button id="planning-next-week">Semaine Suivante &gt;</button>
        </div>
        <div id="planning-calendar-grid" class="planning-calendar-grid">
            <!-- Les en-têtes de jour et les cellules seront générés par JavaScript -->
        </div>
      </div>


      <!-- NOUVEAU: MODAL/PANEL pour un nouvel événement de planning -->
      <div id="planning-event-modal" class="modal-overlay" style="display: none;">
          <div class="modal-content">
              <h3 id="planning-modal-title">Nouvelle Intervention</h3>
              <div class="form-group">
                  <label>Client</label>
                  <div id="planning-client-details" class="client-card" style="display: none;"></div>
                  <div id="planning-client-recherche-container">
                      <div class="facture-search-container">
                          <input type="text" id="planning-recherche-client-input" placeholder="Rechercher un client par nom...">
                          <button onclick="rechercherClientPourPlanning()">Rechercher</button>
                      </div>
                  </div>
              </div>
              <div class="form-group"><label for="planning-start-datetime">Date et Heure de début</label><input type="datetime-local" id="planning-start-datetime"></div>
              <div class="form-group"><label for="planning-work-description">Travaux à réaliser</label><textarea id="planning-work-description" rows="3"></textarea></div>
              <div class="form-group"><label for="planning-technician-name">Technicien en charge</label><input type="text" id="planning-technician-name"></div>
              <div class="form-group"><label for="planning-car-registration">Immatriculation du véhicule</label><input type="text" id="planning-car-registration"></div>
              <button type="button" onclick="sauvegarderEvenement()">Sauvegarder</button>
              <button type="button" onclick="fermerModalNouvelEvenement()">Annuler</button>
          </div>
      </div>

      <!-- NOUVEAU: MODAL/PANEL de recherche de CLIENT pour le planning -->
      <div id="recherche-client-planning-panel" class="modal-overlay" style="display: none;">
          <div class="modal-content">
              <h3>Sélectionner un client</h3>
              <div id="resultats-recherche-client-planning"></div>
              <button onclick="fermerRechercheClientPlanning()">Fermer</button>
          </div>
      </div>

      <div id="nouvelle-facture-form" style="display: none;">
          <div class="facture-header">
              <h2>Nouvelle Facture N° <span id="facture-numero"></span></h2>
              <div class="facture-date">Date: <span id="facture-date"></span></div>
          </div>

          <div class="facture-client-section">
              <h3>Client</h3>
              <div id="facture-client-details" class="client-card" style="display: none;"></div>
              <div id="facture-client-recherche-container">
                  <div class="facture-search-container">
                      <input type="text" id="facture-recherche-client" placeholder="Rechercher un client par nom...">
                      <button onclick="rechercherClientPourFacture()">Rechercher</button>
                  </div>
              </div>
          </div>

          <div class="facture-lignes-section">
              <h3>Détails de la facture</h3>
              <table id="facture-lignes-table">
                  <thead>
                      <tr><th>Description</th><th>Quantité</th><th>Prix U. HT</th><th>Total HT</th><th>Action</th></tr>
                  </thead>
                  <tbody></tbody>
              </table>
              <button onclick="ajouterLignePiece()">Ajouter une pièce</button>
              <button onclick="ajouterLigneMainDoeuvre()">Ajouter Main d'oeuvre</button>
          </div>
       
          <div class="facture-notes-section">
              <h3>Informations complémentaires</h3>
              <textarea id="facture-infos-complementaires" rows="4"></textarea>
          </div>

          <div class="facture-totaux-section">
              <div class="total-ligne"><span>Total HT :</span> <span id="facture-total-ht">0.00</span> €</div>
              <div class="total-ligne"><span>TVA (20%) :</span> <span id="facture-tva">0.00</span> €</div>
              <div class="total-ligne total-final"><span>TOTAL TTC :</span> <span id="facture-total-ttc">0.00</span> €</div>
          </div>

          <div class="facture-actions" id="facture-actions-initiales"><button onclick="sauvegarderFacture()">Sauvegarder la Facture</button></div>
          <div class="facture-actions" id="facture-actions-post-sauvegarde" style="display:none;"><button id="btn-imprimer-pdf">Imprimer en PDF</button></div>
      </div>

      <div id="client-options" style="display: none;">
        <h2>Client</h2>
        <button onclick="afficherFormulaireNouveauClient()">Nouveau client</button>
        <button onclick="afficherFormulaireRechercheClient()">Client déjà existant</button>
      </div>

      <div id="nouveau-client-form" style="display: none;">
        <h2>Ajouter un nouveau client</h2>
        <div class="form-group"><label for="nom">Nom</label><input type="text" id="nom"></div>
        <div class="form-group"><label for="prenom">Prénom</label><input type="text" id="prenom"></div>
        <div class="form-group"><label for="telephone">Téléphone</label><input type="text" id="telephone"></div>
        <div class="form-group"><label for="email">Email</label><input type="email" id="email"></div>
        <div class="form-group"><label for="adresse">Adresse</label><input type="text" id="adresse"></div>
        <div class="form-group"><label for="code_postal">Code Postal</label><input type="text" id="code_postal"></div>
        <div class="form-group"><label for="ville">Ville</label><input type="text" id="ville"></div>
        <div class="form-group"><label for="pays">Pays</label><input type="text" id="pays"></div>
        <button onclick="ajouterClient()">Sauvegarder</button>
      </div>

      <div id="recherche-client-form" style="display: none;">
        <h2>Rechercher un client</h2>
        <div class="form-group">
            <input type="text" id="recherche-client-input" onkeyup="rechercherClient()" placeholder="Rechercher par nom, prénom, email, etc.">
        </div>
      </div>

      <div id="resultatsRecherche" style="display: none;"></div>

      <div id="interface-pieces" style="display: none;">
        <h2>Gestion des pièces</h2>
        <button onclick="afficherFormulaireNouvellePiece()">Nouvelle référence</button>
        <button onclick="afficherFormulaireRecherchePiece()">Référence connue</button>
      </div>

      <div id="nouveau-piece-form" style="display: block;">
        <h2>Ajouter une nouvelle pièce</h2>
        <div class="form-group"><label for="piece-designation">Désignation</label><input type="text" id="piece-designation"></div>
        <div class="form-group"><label for="piece-ref">Réf.</label><input type="text" id="piece-ref"></div>
        <div class="form-group"><label for="piece-prix-achat">Prix d'achat unitaire HT</label><input type="number" id="piece-prix-achat" step="0.01" placeholder="0.00"></div>
        <div class="form-group"><label for="piece-prix-vente">Prix de vente HT</label><input type="number" id="piece-prix-vente" step="0.01" placeholder="0.00" required=""></div>
        <div class="form-group"><label for="piece-category">Catégorie</label><input type="text" id="piece-category" placeholder="Ex: Moteur, Carrosserie"></div>
        <div class="form-group"><label for="piece-fournisseur">Fournisseur</label><select id="piece-fournisseur" required=""><option value="">Erreur de chargement</option></select></div>
        <button onclick="ajouterPiece()">Sauvegarder</button>
      </div>

      <div id="recherche-piece-form" style="display: none;">
        <h2>Rechercher une pièce</h2>
        <input type="text" id="recherche-piece-designation" placeholder="Désignation">
        <input type="text" id="recherche-piece-ref" placeholder="Référence">
        <button onclick="rechercherPiece()">Rechercher</button>
      </div>

      <div id="resultats-recherche-pieces" style="display: none;"></div>

      <!-- NOUVEAU: Interface Main d'oeuvre -->
      <div id="interface-maindoeuvre" style="display: none;">
        <h2>Gestion de la main d'oeuvre</h2>
        <button onclick="afficherFormulaireNouvelleMainDoeuvre()">Nouveau type</button>
        <button onclick="afficherFormulaireRechercheMainDoeuvre()">Rechercher un type</button>
      </div>

      <div id="nouveau-maindoeuvre-form" style="display: none;">
        <h2>Ajouter un type de main d'oeuvre</h2>
        <div class="form-group"><label for="maindoeuvre-description">Description</label><input type="text" id="maindoeuvre-description"></div>
        <div class="form-group"><label for="maindoeuvre-taux-horaire">Taux horaire HT</label><input type="number" id="maindoeuvre-taux-horaire" step="0.01" placeholder="0.00"></div>
        <button onclick="ajouterMainDoeuvre()">Sauvegarder</button>
      </div>

      <div id="recherche-maindoeuvre-form" style="display: none;">
        <h2>Rechercher un type de main d'oeuvre</h2>
        <input type="text" id="recherche-maindoeuvre-description" placeholder="Description">
        <button onclick="rechercherMainDoeuvre()">Rechercher</button>
      </div>

      <div id="resultats-recherche-maindoeuvre" style="display: none;"></div>
      <!-- NOUVEAU: Interface Options -->
      <div id="interface-options" style="display: none;">
        <h2>Options</h2>
        <div style="display: flex; flex-direction: row; gap: 10px;">
            <button onclick="afficherInterfaceFournisseurs()">Fournisseurs</button>
            <button onclick="afficherInterfaceAssureurs()">Assureurs</button>
            <button onclick="afficherInterfaceExperts()">Experts</button>
            <button>Réglage</button>
        </div>
      </div>

      <!-- NOUVEAU: Interface Fournisseurs -->
      <div id="interface-fournisseurs" style="display: none;">
        <h2>Gestion des Fournisseurs</h2>
        <button onclick="openFournisseurModal()">Ajouter un nouveau fournisseur</button>
        <div class="form-group" style="margin-top: 15px;">
            <input type="text" id="recherche-fournisseur-input" onkeyup="loadFournisseurs()" placeholder="Rechercher un fournisseur par nom...">
        </div>
        <div id="resultats-fournisseurs" style="margin-top: 10px;">
            <!-- Liste des fournisseurs -->
        </div>
      </div>

      <!-- NOUVEAU: MODAL/PANEL pour ajouter/modifier un Fournisseur -->
      <div id="fournisseur-modal" class="modal-overlay" style="display: none;">
          <div class="modal-content">
              <h3 id="fournisseur-modal-title">Ajouter un Fournisseur</h3>
              <input type="hidden" id="fournisseur-id">
              <div class="form-group"><label for="fournisseur-nom">Nom du Fournisseur</label><input type="text" id="fournisseur-nom"></div>
              <div class="form-group"><label for="fournisseur-contact">Personne Contact</label><input type="text" id="fournisseur-contact"></div>
              <div class="form-group"><label for="fournisseur-telephone">Téléphone</label><input type="text" id="fournisseur-telephone"></div>
              <div class="form-group"><label for="fournisseur-email">Email</label><input type="email" id="fournisseur-email"></div>
              <div class="form-group"><label for="fournisseur-adresse">Adresse</label><input type="text" id="fournisseur-adresse"></div>
              <div class="form-group"><label for="fournisseur-delai-livraison">Délai moyen de livraison (jours)</label><input type="number" id="fournisseur-delai-livraison" min="0"></div>
              <button type="button" onclick="saveFournisseur()">Sauvegarder</button>
              <button type="button" onclick="closeFournisseurModal()">Annuler</button>
          </div>
      </div>

      <!-- NOUVEAU: MODAL/PANEL pour ajouter/modifier une Remise Fournisseur -->
      <div id="remise-fournisseur-modal" class="modal-overlay" style="display: none;">
          <div class="modal-content">
              <h3 id="remise-fournisseur-modal-title">Ajouter une Remise</h3>
              <input type="hidden" id="remise-id">
              <input type="hidden" id="remise-fournisseur-id">
              <div class="form-group"><label for="remise-piece-category">Catégorie de Pièce</label><input type="text" id="remise-piece-category"></div>
              <div class="form-group"><label for="remise-pourcentage">Pourcentage de Remise (%)</label><input type="number" id="remise-pourcentage" step="0.01" min="0" max="100"></div>
              <button type="button" onclick="saveRemise()">Sauvegarder</button>
              <button type="button" onclick="closeRemiseModal()">Annuler</button>
          </div>
      </div>

      <!-- NOUVEAU: Interface de Détails Fournisseur (pour afficher les remises) -->
      <div id="fournisseur-details-view" class="modal-overlay" style="display: none;">
          <div class="modal-content">
              <h3 id="fournisseur-details-name"></h3>
              <p>Délai de livraison moyen: <span id="fournisseur-details-delai"></span></p>
              <h4>Remises par Catégorie</h4>
              <button onclick="openRemiseModal(null, currentFournisseurId)">Ajouter une Remise</button>
              <table id="remises-table" style="width:100%; border-collapse: collapse; margin-top: 10px;"><thead><tr><th>Catégorie</th><th>Remise (%)</th><th>Actions</th></tr></thead><tbody></tbody></table>
              <button onclick="closeFournisseurDetailsView()">Fermer</button>
          </div>
      </div>

      <!-- NOUVEAU: Interface Assureurs -->
      <div id="interface-assureurs" style="display: none;">
        <h2>Gestion des Assureurs</h2>
        <button onclick="openAssureurModal()">Ajouter un nouvel assureur</button>
        <div class="form-group" style="margin-top: 15px;">
            <input type="text" id="recherche-assureur-input" onkeyup="loadAssureurs()" placeholder="Rechercher un assureur par nom...">
        </div>
        <div id="resultats-assureurs" style="margin-top: 10px;">
            <!-- Liste des assureurs -->
        </div>
      </div>

      <!-- NOUVEAU: MODAL/PANEL pour ajouter/modifier un Assureur -->
      <div id="assureur-modal" class="modal-overlay" style="display: none;">
          <div class="modal-content">
              <h3 id="assureur-modal-title">Ajouter un Assureur</h3>
              <input type="hidden" id="assureur-id">
              <div class="form-group"><label for="assureur-nom">Nom de l'Assureur</label><input type="text" id="assureur-nom"></div>
              <div class="form-group"><label for="assureur-contact">Personne Contact</label><input type="text" id="assureur-contact"></div>
              <div class="form-group"><label for="assureur-telephone">Téléphone</label><input type="text" id="assureur-telephone"></div>
              <div class="form-group"><label for="assureur-email">Email</label><input type="email" id="assureur-email"></div>
              <div class="form-group"><label for="assureur-adresse">Adresse</label><input type="text" id="assureur-adresse"></div>
              <div class="form-group"><label for="assureur-delai-paiement">Délai moyen de paiement (jours)</label><input type="number" id="assureur-delai-paiement" min="0"></div>
              <button type="button" onclick="saveAssureur()">Sauvegarder</button>
              <button type="button" onclick="closeAssureurModal()">Annuler</button>
          </div>
      </div>

      <!-- NOUVEAU: Interface Experts -->
      <div id="interface-experts" style="display: none;">
        <h2>Gestion des Experts</h2>
        <button onclick="openExpertModal()">Ajouter un nouvel expert</button>
        <div class="form-group" style="margin-top: 15px;">
            <input type="text" id="recherche-expert-input" onkeyup="loadExperts()" placeholder="Rechercher un expert par nom...">
        </div>
        <div id="resultats-experts" style="margin-top: 10px;">
            <!-- Liste des experts -->
        </div>
      </div>

      <!-- NOUVEAU: MODAL/PANEL pour ajouter/modifier un Expert -->
      <div id="expert-modal" class="modal-overlay" style="display: none;">
          <div class="modal-content">
              <h3 id="expert-modal-title">Ajouter un Expert</h3>
              <input type="hidden" id="expert-id">
              <div class="form-group"><label for="expert-nom">Nom de l'Expert</label><input type="text" id="expert-nom"></div>
              <div class="form-group"><label for="expert-contact">Personne Contact</label><input type="text" id="expert-contact"></div>
              <div class="form-group"><label for="expert-telephone">Téléphone</label><input type="text" id="expert-telephone"></div>
              <div class="form-group"><label for="expert-email">Email</label><input type="email" id="expert-email"></div>
              <div class="form-group"><label for="expert-adresse">Adresse</label><input type="text" id="expert-adresse"></div>
              <div class="form-group"><label for="expert-delai-reponse">Délai moyen de réponse (jours)</label><input type="number" id="expert-delai-reponse" min="0"></div>
              <button type="button" onclick="saveExpert()">Sauvegarder</button>
              <button type="button" onclick="closeExpertModal()">Annuler</button>
          </div>
      </div>

      <!-- NOUVEAU: Interface Technicien -->
      <div id="interface-technicien" style="display: none;">
        <h2>Gestion des Techniciens</h2>
        <button onclick="afficherFormulaireNouveauTechnicien()">Nouveau Technicien</button>
        <button onclick="afficherListeTechniciens()">Liste des Techniciens</button>
      </div>

      <!-- NOUVEAU: Formulaire pour un nouveau technicien -->
      <div id="nouveau-technicien-form" style="display: none;">
        <h2>Ajouter un nouveau technicien</h2>
        <div class="form-group"><label for="tech-nom">Nom</label><input type="text" id="tech-nom"></div>
        <div class="form-group"><label for="tech-prenom">Prénom</label><input type="text" id="tech-prenom"></div>
        <div class="form-group"><label for="tech-adresse">Adresse</label><input type="text" id="tech-adresse"></div>
        <div class="form-group"><label for="tech-code-postal">Code Postal</label><input type="text" id="tech-code-postal"></div>
        <div class="form-group"><label for="tech-ville">Ville</label><input type="text" id="tech-ville"></div>
        <div class="form-group"><label for="tech-date-naissance">Date de naissance</label><input type="date" id="tech-date-naissance"></div>
        <div class="form-group"><label for="tech-email">Email</label><input type="email" id="tech-email"></div>
        <div class="form-group"><label for="tech-telephone">Téléphone</label><input type="text" id="tech-telephone"></div>
        <div class="form-group"><label for="tech-numero">Numéro de technicien</label><input type="text" id="tech-numero"></div>
        <button onclick="ajouterTechnicien()">Sauvegarder</button>
      </div>

<div <div="" id="accueil-section" class="header" style="display: none;">
  <h2>Bienvenue dans IA Carrossery</h2>
  <p id="date-heure-accueil" style="font-size:1.2em; color:#333;">Lundi 7 juillet 2025 - 11:20:05</p>

  <div id="visuels-accueil">
    <!-- Planning du jour -->
    <div id="planning-jour-accueil" class="card-accueil">
      <h3>Planning du jour</h3>
      <div id="planning-jour-container"><p>Erreur de chargement.</p></div>
    </div>
    <!-- Objectif CA du jour -->
    <div id="objectif-ca-jour" class="card-accueil">
      <h3>Objectif CA du jour</h3>
      <p id="objectif-ca-container">Erreur</p>

    </div>
  </div>
</div>
   </div>
   
  

  <script>
    // Renommé pour plus de clarté : cache tous les panneaux de contenu principaux
    function hideAllContentPanels() {
        const panelIds = [
            'accueil-section', 'client-options', 'nouveau-client-form', 'nouveau-piece-form', 'recherche-piece-form', 'resultats-recherche-pieces',
            'facture-options', 'nouvelle-facture-form', 'recherche-facture-form', 'resultats-recherche-factures', 'interface-maindoeuvre', 'interface-technicien', 'nouveau-technicien-form',
            'nouveau-maindoeuvre-form', 'recherche-maindoeuvre-form', 'resultats-recherche-maindoeuvre', 'interface-planning', 'interface-fournisseurs',
            'recherche-client-form', 'resultatsRecherche', 'interface-pieces', 'interface-options', 'interface-comptabilite' // AJOUTÉ interface-fournisseurs
        ];
        panelIds.forEach(id => {
            const panel = document.getElementById(id);
            if (panel) panel.style.display = 'none';
        });
        const newPanelIds = [
            'interface-assureurs',
            'interface-experts'
        ];
        newPanelIds.forEach(id => {
            const panel = document.getElementById(id);
            if (panel) panel.style.display = 'none';
        });
    }

    // Variable globale pour stocker l'historique des panneaux de contenu principaux
    let panelHistory = [];
    const MAX_HISTORY_SIZE = 10; // Limite l'historique pour éviter une utilisation excessive de la mémoire

    // Fonction centrale pour afficher un panneau de contenu principal et gérer l'historique
    function showPanel(panelId, addToHistory = true) {
        hideAllContentPanels(); // Cache d'abord tous les panneaux de contenu principaux

        const panelToShow = document.getElementById(panelId);
        if (panelToShow) {
            panelToShow.style.display = 'block';
        } else {
            console.warn(`Panneau principal avec l'ID '${panelId}' non trouvé.`);
            return; // Sortir si le panneau n'existe pas
        }

        if (addToHistory) {
            // Empêche d'ajouter le même panneau plusieurs fois s'il est déjà le dernier
            if (panelHistory.length === 0 || panelHistory[panelHistory.length - 1] !== panelId) {
                panelHistory.push(panelId);
                // Réduire l'historique s'il devient trop long
                if (panelHistory.length > MAX_HISTORY_SIZE) {
                    panelHistory.shift(); // Supprime l'entrée la plus ancienne
                }
            }
        }
    }

    // Fonction pour fermer toute modale actuellement ouverte
    function closeOpenModal() {
        const modals = document.querySelectorAll('.modal-overlay');
        let modalClosed = false;
        modals.forEach(modal => {
            if (modal.style.display === 'flex') { // Les modales sont affichées avec 'flex'
                modal.style.display = 'none';
                modalClosed = true;
            }
        });
        return modalClosed; // Renvoie true si une modale a été fermée, false sinon
    }

    // Fonction pour revenir en arrière dans l'historique ou fermer une modale
    function goBack() {
        if (closeOpenModal()) { return; } // Une modale a été fermée, on s'arrête là.
        if (panelHistory.length > 1) {
            panelHistory.pop(); // Supprime le panneau actuel de l'historique
            const previousPanelId = panelHistory[panelHistory.length - 1]; // Récupère l'ID du panneau précédent
            showPanel(previousPanelId, false); // L'affiche, mais sans l'ajouter à nouveau à l'historique
        } else { showPanel('accueil-section', false); } // Si l'historique est vide ou n'a qu'un seul élément, on va à l'accueil
    }

    // --- NOUVEAU: Logique des Fournisseurs ---
    let currentFournisseurId = null; // Pour savoir quel fournisseur est en cours de modification/visualisation

    function afficherInterfaceFournisseurs() {
        showPanel('interface-fournisseurs');
        loadFournisseurs();
    }

    function loadFournisseurs() {
        const searchTerm = document.getElementById('recherche-fournisseur-input').value;
        const container = document.getElementById('resultats-fournisseurs');
        container.innerHTML = 'Chargement des fournisseurs...';

        fetch(`/api/fournisseurs?q=${encodeURIComponent(searchTerm)}`)
            .then(response => response.json())
            .then(fournisseurs => {
                container.innerHTML = '';
                if (fournisseurs.length === 0) {
                    container.innerHTML = '<p>Aucun fournisseur trouvé.</p>';
                    return;
                }
                fournisseurs.forEach(fournisseur => {
                    const bloc = document.createElement('div');
                    bloc.className = 'client-card'; // Réutilise le style
                    bloc.innerHTML = `
                        <h4>${fournisseur.nom}</h4>
                        <p>Contact: ${fournisseur.contact_person || 'N/A'}</p>
                        <p>Téléphone: ${fournisseur.telephone || 'N/A'}</p>
                        <button onclick='openFournisseurModal(${JSON.stringify(fournisseur)})'>Modifier</button>
                        <button onclick="deleteFournisseur(${fournisseur.id})">Supprimer</button>
                        <button onclick="displayFournisseurDetails(${fournisseur.id})">Détails & Remises</button>
                    `;
                    container.appendChild(bloc);
                });
            })
            .catch(error => {
                console.error("Erreur lors du chargement des fournisseurs:", error);
                container.innerHTML = '<p>Erreur lors du chargement des fournisseurs.</p>';
            });
    }

    function openFournisseurModal(fournisseur = null) {
        document.getElementById('fournisseur-id').value = fournisseur ? fournisseur.id : '';
        document.getElementById('fournisseur-nom').value = fournisseur ? fournisseur.nom : '';
        document.getElementById('fournisseur-contact').value = fournisseur ? fournisseur.contact_person : '';
        document.getElementById('fournisseur-telephone').value = fournisseur ? fournisseur.telephone : '';
        document.getElementById('fournisseur-email').value = fournisseur ? fournisseur.email : '';
        document.getElementById('fournisseur-adresse').value = fournisseur ? fournisseur.adresse : '';
        document.getElementById('fournisseur-delai-livraison').value = fournisseur ? fournisseur.delai_livraison_moyen : '';
        document.getElementById('fournisseur-modal-title').innerText = fournisseur ? 'Modifier le Fournisseur' : 'Ajouter un Fournisseur';
        document.getElementById('fournisseur-modal').style.display = 'flex';
    }

    function closeFournisseurModal() {
        document.getElementById('fournisseur-modal').style.display = 'none';
    }

    function saveFournisseur() {
        const id = document.getElementById('fournisseur-id').value;
        const fournisseurData = {
            nom: document.getElementById('fournisseur-nom').value,
            contact_person: document.getElementById('fournisseur-contact').value,
            telephone: document.getElementById('fournisseur-telephone').value,
            email: document.getElementById('fournisseur-email').value,
            adresse: document.getElementById('fournisseur-adresse').value,
            delai_livraison_moyen: document.getElementById('fournisseur-delai-livraison').value ? parseInt(document.getElementById('fournisseur-delai-livraison').value) : null
        };

        if (!fournisseurData.nom) { alert("Le nom du fournisseur est obligatoire."); return; }

        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/fournisseurs/${id}` : '/api/fournisseurs';

        fetch(url, { // L'URL est maintenant relative, ce qui résout le problème
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(fournisseurData)
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    let errorMessage = `Server error (${response.status}): ${text}`;
                    try {
                        const errorData = JSON.parse(text);
                        errorMessage = errorData.message || JSON.stringify(errorData);
                    } catch (e) { /* Not JSON, use default text */ }
                    throw new Error(errorMessage);
                });
            }
            return response.json();
        })
        .then(data => {
            alert(data.message);
            closeFournisseurModal();
            loadFournisseurs();
        })
        .catch(error => {
            console.error("Erreur sauvegarde fournisseur:", error);
            alert(`Erreur: ${error.message}`);
        });
    }

    function deleteFournisseur(id) {
        if (!confirm("Confirmer la suppression de ce fournisseur ?")) return;
        fetch(`/api/fournisseurs/${id}`, { method: 'DELETE' })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        let errorMessage = `Server error (${response.status}): ${text}`;
                        try {
                            const errorData = JSON.parse(text);
                            errorMessage = errorData.message || JSON.stringify(errorData);
                        } catch (e) { /* Not JSON, use default text */ }
                        throw new Error(errorMessage);
                    });
                }
                return response.json();
            })
            .then(data => {
                alert(data.message);
                loadFournisseurs();
            })
            .catch(error => {
                console.error("Erreur suppression fournisseur:", error);
                alert(`Erreur: ${error.message}`);
            });
    }

    function displayFournisseurDetails(fournisseurId) {
        currentFournisseurId = fournisseurId; // Stocke l'ID du fournisseur actuel
        fetch(`/api/fournisseurs/${fournisseurId}`)
            .then(response => response.json())
            .then(fournisseur => {
                document.getElementById('fournisseur-details-name').innerText = fournisseur.nom;
                const delai = fournisseur.delai_livraison_moyen;
                document.getElementById('fournisseur-details-delai').innerText = delai !== null ? `${delai} jours` : 'N/A';
                loadRemisesForFournisseur(fournisseurId);
                document.getElementById('fournisseur-details-view').style.display = 'flex';
            })
            .catch(error => console.error("Erreur chargement détails fournisseur:", error));
    }

    function closeFournisseurDetailsView() {
        document.getElementById('fournisseur-details-view').style.display = 'none';
        currentFournisseurId = null;
    }

    function loadRemisesForFournisseur(fournisseurId) {
        const tableBody = document.querySelector('#remises-table tbody');
        tableBody.innerHTML = '<tr><td colspan="3">Chargement des remises...</td></tr>';
        fetch(`/api/fournisseurs/${fournisseurId}/remises`)
            .then(response => response.json())
            .then(remises => {
                tableBody.innerHTML = '';
                if (remises.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="3">Aucune remise configurée.</td></tr>';
                    return;
                }
                remises.forEach(remise => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `<td>${remise.piece_category}</td><td>${remise.remise_pourcentage}%</td><td><button onclick="alert('Modifier/Supprimer remise non implémenté')">Actions</button></td>`;
                });
            })
            .catch(error => { console.error("Erreur chargement remises:", error); tableBody.innerHTML = '<tr><td colspan="3">Erreur de chargement des remises.</td></tr>'; });
    }

    function openRemiseModal(remise = null, fournisseurId = null) {
        document.getElementById('remise-id').value = remise ? remise.id : '';
        document.getElementById('remise-fournisseur-id').value = fournisseurId || currentFournisseurId;
        document.getElementById('remise-piece-category').value = remise ? remise.piece_category : '';
        document.getElementById('remise-pourcentage').value = remise ? remise.remise_pourcentage : '';
        document.getElementById('remise-fournisseur-modal-title').innerText = remise ? 'Modifier la Remise' : 'Ajouter une Remise';
        document.getElementById('remise-fournisseur-modal').style.display = 'flex';
    }

    function closeRemiseModal() {
        document.getElementById('remise-fournisseur-modal').style.display = 'none';
    }

    function saveRemise() {
        const id = document.getElementById('remise-id').value;
        const fournisseurId = document.getElementById('remise-fournisseur-id').value;
        const remiseData = {
            piece_category: document.getElementById('remise-piece-category').value,
            remise_pourcentage: parseFloat(document.getElementById('remise-pourcentage').value)
        };

        if (!remiseData.piece_category || isNaN(remiseData.remise_pourcentage)) { alert("Catégorie et pourcentage sont obligatoires."); return; }

        const method = id ? 'PUT' : 'POST'; // PUT pour modifier, POST pour ajouter
        const url = id ? `/api/remises_fournisseur/${id}` : `/api/fournisseurs/${fournisseurId}/remises`;

        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(remiseData)
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    let errorMessage = `Server error (${response.status}): ${text}`;
                    try {
                        const errorData = JSON.parse(text);
                        errorMessage = errorData.message || JSON.stringify(errorData);
                    } catch (e) { /* Not JSON, use default text */ }
                    throw new Error(errorMessage);
                });
            }
            return response.json();
        })
        .then(data => {
            alert(data.message);
            closeRemiseModal();
            loadRemisesForFournisseur(fournisseurId); // Rafraîchit la liste des remises
        })
        .catch(error => {
            console.error("Erreur sauvegarde remise:", error);
            alert(`Erreur: ${error.message}`);
        });
    }

    // --- NOUVEAU: Logique des Assureurs ---

    function afficherInterfaceAssureurs() {
        showPanel('interface-assureurs');
        loadAssureurs();
    }

    function loadAssureurs() {
        const searchTerm = document.getElementById('recherche-assureur-input').value;
        const container = document.getElementById('resultats-assureurs');
        container.innerHTML = 'Chargement des assureurs...';

        fetch(`/api/assureurs?q=${encodeURIComponent(searchTerm)}`)
            .then(response => response.json())
            .then(assureurs => {
                container.innerHTML = '';
                if (assureurs.length === 0) {
                    container.innerHTML = '<p>Aucun assureur trouvé.</p>';
                    return;
                }
                assureurs.forEach(assureur => {
                    const bloc = document.createElement('div');
                    bloc.className = 'client-card'; // Réutilise le style
                    bloc.innerHTML = `
                        <h4>${assureur.nom}</h4>
                        <p>Contact: ${assureur.contact_person || 'N/A'}</p>
                        <p>Téléphone: ${assureur.telephone || 'N/A'}</p>
                        <p>Délai de paiement moyen: ${assureur.delai_paiement_moyen !== null ? assureur.delai_paiement_moyen + ' jours' : 'N/A'}</p>
                        <button onclick='openAssureurModal(${JSON.stringify(assureur)})'>Modifier</button>
                        <button onclick="deleteAssureur(${assureur.id})">Supprimer</button>
                    `;
                    container.appendChild(bloc);
                });
            })
            .catch(error => {
                console.error("Erreur lors du chargement des assureurs:", error);
                container.innerHTML = '<p>Erreur lors du chargement des assureurs.</p>';
            });
    }

    function openAssureurModal(assureur = null) {
        document.getElementById('assureur-id').value = assureur ? assureur.id : '';
        document.getElementById('assureur-nom').value = assureur ? assureur.nom : '';
        document.getElementById('assureur-contact').value = assureur ? assureur.contact_person : '';
        document.getElementById('assureur-telephone').value = assureur ? assureur.telephone : '';
        document.getElementById('assureur-email').value = assureur ? assureur.email : '';
        document.getElementById('assureur-adresse').value = assureur ? assureur.adresse : '';
        document.getElementById('assureur-delai-paiement').value = assureur ? assureur.delai_paiement_moyen : '';
        document.getElementById('assureur-modal-title').innerText = assureur ? "Modifier l'Assureur" : 'Ajouter un Assureur';
        document.getElementById('assureur-modal').style.display = 'flex';
    }

    function closeAssureurModal() {
        document.getElementById('assureur-modal').style.display = 'none';
    }

    function saveAssureur() {
        const id = document.getElementById('assureur-id').value;
        const assureurData = {
            nom: document.getElementById('assureur-nom').value,
            contact_person: document.getElementById('assureur-contact').value,
            telephone: document.getElementById('assureur-telephone').value,
            email: document.getElementById('assureur-email').value,
            adresse: document.getElementById('assureur-adresse').value,
            delai_paiement_moyen: document.getElementById('assureur-delai-paiement').value ? parseInt(document.getElementById('assureur-delai-paiement').value) : null
        };

        if (!assureurData.nom) { alert("Le nom de l'assureur est obligatoire."); return; }

        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/assureurs/${id}` : '/api/assureurs';

        fetch(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(assureurData) })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.message || JSON.stringify(errorData));
                    }).catch(() => response.text().then(text => { throw new Error(`Server error (${response.status}): ${text}`); }));
                }
                return response.json();
            })
            .then(data => { alert(data.message); closeAssureurModal(); loadAssureurs(); })
            .catch(error => { console.error("Erreur sauvegarde assureur:", error); alert(`Erreur: ${error.message}`); });
        }

    function deleteAssureur(id) {
        if (!confirm("Confirmer la suppression de cet assureur ?")) return;
        fetch(`/api/assureurs/${id}`, { method: 'DELETE' })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.message || JSON.stringify(errorData));
                    }).catch(() => response.text().then(text => { throw new Error(`Server error (${response.status}): ${text}`); }));
                }
                return response.json();
            })
            .then(data => { alert(data.message); loadAssureurs(); })
            .catch(error => { console.error("Erreur suppression assureur:", error); alert(`Erreur: ${error.message}`); });
    }

    // --- NOUVEAU: Logique des Experts ---

    function afficherInterfaceExperts() {
        showPanel('interface-experts');
        loadExperts();
    }

    function loadExperts() {
        const searchTerm = document.getElementById('recherche-expert-input').value;
        const container = document.getElementById('resultats-experts');
        container.innerHTML = 'Chargement des experts...';

        fetch(`/api/experts?q=${encodeURIComponent(searchTerm)}`)
            .then(response => response.json())
            .then(experts => {
                container.innerHTML = '';
                if (experts.length === 0) {
                    container.innerHTML = '<p>Aucun expert trouvé.</p>';
                    return;
                }
                experts.forEach(expert => {
                    const bloc = document.createElement('div');
                    bloc.className = 'client-card'; // Réutilise le style
                    bloc.innerHTML = `
                        <h4>${expert.nom}</h4>
                        <p>Contact: ${expert.contact_person || 'N/A'}</p>
                        <p>Téléphone: ${expert.telephone || 'N/A'}</p>
                        <p>Délai de réponse moyen: ${expert.delai_reponse_moyen !== null ? expert.delai_reponse_moyen + ' jours' : 'N/A'}</p>
                        <button onclick='openExpertModal(${JSON.stringify(expert)})'>Modifier</button>
                        <button onclick="deleteExpert(${expert.id})">Supprimer</button>
                    `;
                    container.appendChild(bloc);
                });
            })
            .catch(error => {
                console.error("Erreur lors du chargement des experts:", error);
                container.innerHTML = '<p>Erreur lors du chargement des experts.</p>';
            });
    }

    function openExpertModal(expert = null) {
        document.getElementById('expert-id').value = expert ? expert.id : '';
        document.getElementById('expert-nom').value = expert ? expert.nom : '';
        document.getElementById('expert-contact').value = expert ? expert.contact_person : '';
        document.getElementById('expert-telephone').value = expert ? expert.telephone : '';
        document.getElementById('expert-email').value = expert ? expert.email : '';
        document.getElementById('expert-adresse').value = expert ? expert.adresse : '';
        document.getElementById('expert-delai-reponse').value = expert ? expert.delai_reponse_moyen : '';
        document.getElementById('expert-modal-title').innerText = expert ? "Modifier l'Expert" : 'Ajouter un Expert';
        document.getElementById('expert-modal').style.display = 'flex';
    }

    function closeExpertModal() {
        document.getElementById('expert-modal').style.display = 'none';
    }

    function saveExpert() {
        const id = document.getElementById('expert-id').value;
        const expertData = {
            nom: document.getElementById('expert-nom').value,
            contact_person: document.getElementById('expert-contact').value,
            telephone: document.getElementById('expert-telephone').value,
            email: document.getElementById('expert-email').value,
            adresse: document.getElementById('expert-adresse').value,
            delai_reponse_moyen: document.getElementById('expert-delai-reponse').value ? parseInt(document.getElementById('expert-delai-reponse').value) : null
        };

        if (!expertData.nom) { alert("Le nom de l'expert est obligatoire."); return; }

        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/experts/${id}` : '/api/experts';

        fetch(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(expertData) })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.message || JSON.stringify(errorData));
                    }).catch(() => response.text().then(text => { throw new Error(`Server error (${response.status}): ${text}`); }));
                }
                return response.json();
            })
            .then(data => { alert(data.message); closeExpertModal(); loadExperts(); })
            .catch(error => { console.error("Erreur sauvegarde expert:", error); alert(`Erreur: ${error.message}`); });
    }

    function deleteExpert(id) {
        if (!confirm("Confirmer la suppression de cet expert ?")) return;
        fetch(`/api/experts/${id}`, { method: 'DELETE' })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.message || JSON.stringify(errorData));
                    }).catch(() => response.text().then(text => { throw new Error(`Server error (${response.status}): ${text}`); }));
                }
                return response.json();
            })
            .then(data => { alert(data.message); loadExperts(); })
            .catch(error => { console.error("Erreur suppression expert:", error); alert(`Erreur: ${error.message}`); });
    }

       // --- Logique du Planning ---
    let planningEventActuel = { clientId: null };
    let dateAffichee = new Date(); // Date actuellement affichée dans le planning

    function afficherInterfacePlanning() {
        showPanel('interface-planning'); // F8 - Planning
        setupPlanningCalendar();
        chargerEvenementsPlanning();
    }

    function setupPlanningCalendar() {
        // Clonage pour éviter les écouteurs d'événements multiples
        const prevButton = document.getElementById('planning-prev-week');
        const nextButton = document.getElementById('planning-next-week');
        
        const newPrevButton = prevButton.cloneNode(true);
        prevButton.parentNode.replaceChild(newPrevButton, prevButton);
        
        const newNextButton = nextButton.cloneNode(true);
        nextButton.parentNode.replaceChild(newNextButton, nextButton);

        newPrevButton.addEventListener('click', () => {
            dateAffichee.setDate(dateAffichee.getDate() - 7);
            chargerEvenementsPlanning();
        });

        newNextButton.addEventListener('click', () => {
            dateAffichee.setDate(dateAffichee.getDate() + 7);
            chargerEvenementsPlanning();
        });
    }

    function chargerEvenementsPlanning() {
        const grid = document.getElementById('planning-calendar-grid');
        grid.innerHTML = 'Chargement...';

        const debutSemaine = new Date(dateAffichee);
        debutSemaine.setDate(debutSemaine.getDate() - debutSemaine.getDay() + (debutSemaine.getDay() === 0 ? -6 : 1)); // Lundi
        debutSemaine.setHours(0, 0, 0, 0);

        const finSemaine = new Date(debutSemaine);
        finSemaine.setDate(finSemaine.getDate() + 6);
        finSemaine.setHours(23, 59, 59, 999);

        document.getElementById('planning-current-week').innerText =
            `Semaine du ${debutSemaine.toLocaleDateString('fr-FR')} au ${finSemaine.toLocaleDateString('fr-FR')}`;

        // L'URL inclut maintenant les dates de début et de fin
        fetch(`/api/planning?start_date=${debutSemaine.toISOString().split('T')[0]}&end_date=${finSemaine.toISOString().split('T')[0]}`)
            .then(response => response.json())
            .then(events => {
                genererGrilleCalendrier(grid, debutSemaine, events);
            })
            .catch(error => {
                console.error("Erreur lors du chargement du planning:", error);
                grid.innerHTML = '<p>Erreur de chargement du planning.</p>';
            });
    }

    function genererGrilleCalendrier(grid, debutSemaine, events) {
        grid.innerHTML = ''; // Vider la grille

        // 1. Créer la ligne d'en-tête des jours
        const headerRow = document.createElement('div');
        headerRow.style.gridColumn = '1 / -1';
        headerRow.style.display = 'contents';
        grid.appendChild(headerRow);

        headerRow.appendChild(document.createElement('div')); // Cellule vide coin supérieur gauche

        const jours = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
        for (let i = 0; i < 7; i++) {
            const jourActuel = new Date(debutSemaine);
            jourActuel.setDate(jourActuel.getDate() + i);
            const dayHeader = document.createElement('div');
            dayHeader.className = 'calendar-day-header';
            dayHeader.innerText = `${jours[i]}\n${jourActuel.toLocaleDateString('fr-FR', {day: '2-digit', month: '2-digit'})}`;
            headerRow.appendChild(dayHeader);
        }

        // 2. Créer les lignes pour les heures (de 8h à 19h)
        for (let heure = 8; heure <= 19; heure++) {
            const timeLabel = document.createElement('div');
            timeLabel.className = 'calendar-time-label';
            timeLabel.innerText = `${heure}:00`;
            grid.appendChild(timeLabel);

            for (let jour = 0; jour < 7; jour++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-grid-cell';
                const cellDate = new Date(debutSemaine);
                cellDate.setDate(debutSemaine.getDate() + jour);
                cell.dataset.date = cellDate.toISOString().split('T')[0];
                cell.dataset.hour = heure;
                grid.appendChild(cell);
            }
        }

        // 3. Placer les événements dans la grille
        events.forEach(event => {
            const eventDate = new Date(event.start_datetime);
            const eventHour = eventDate.getHours();
            const eventDateString = eventDate.toISOString().split('T')[0];

            const targetCell = grid.querySelector(`[data-date='${eventDateString}'][data-hour='${eventHour}']`);

            if (targetCell) {
                const eventSlot = document.createElement('div');
                eventSlot.className = 'calendar-event-slot';
                eventSlot.innerText = `${event.client.nom} - ${event.work_description}`;
                eventSlot.title = `Client: ${event.client.prenom} ${event.client.nom}\nTechnicien: ${event.technician_name}\nDescription: ${event.work_description}`;
                targetCell.appendChild(eventSlot);
            }
        });
    }


    function ouvrirModalNouvelEvenement() {
        planningEventActuel = { clientId: null };
        document.getElementById('planning-modal-title').innerText = 'Nouvelle Intervention';
        document.getElementById('planning-client-details').style.display = 'none';
        document.getElementById('planning-client-recherche-container').style.display = 'block';
        document.getElementById('planning-recherche-client-input').value = '';
        document.getElementById('planning-start-datetime').value = '';
        document.getElementById('planning-work-description').value = '';
        document.getElementById('planning-technician-name').value = '';
        document.getElementById('planning-car-registration').value = '';
        document.getElementById('planning-event-modal').style.display = 'flex';
    }

    function fermerModalNouvelEvenement() {
        document.getElementById('planning-event-modal').style.display = 'none';
    }

    function rechercherClientPourPlanning() {
        const searchTerm = document.getElementById('planning-recherche-client-input').value;
        if (searchTerm.length < 2) { return; }
        const resultsContainer = document.getElementById('resultats-recherche-client-planning');
        fetch(`/api/clients/search?q=${searchTerm}`)
            .then(response => response.json())
            .then(clients => {
                resultsContainer.innerHTML = '';
                if (clients.length === 0) {
                    resultsContainer.innerHTML = '<p>Aucun client trouvé.</p>';
                } else {
                    clients.forEach(client => {
                        const bloc = document.createElement("div");
                        bloc.className = "resultat-recherche-facture-item";
                        bloc.innerHTML = `<p><strong>${client.nom} ${client.prenom || ''}</strong> - ${client.ville || ''}</p>`;
                        bloc.onclick = () => selectionnerClientPourPlanning(client);
                        resultsContainer.appendChild(bloc);
                    });
                }
                document.getElementById('recherche-client-planning-panel').style.display = 'flex';
            }).catch(error => console.error("Erreur de recherche client:", error));
    }

    function fermerRechercheClientPlanning() {
        document.getElementById('recherche-client-planning-panel').style.display = 'none';
    }

    function selectionnerClientPourPlanning(client) {
        planningEventActuel.clientId = client.id;
        const detailsContainer = document.getElementById('planning-client-details');
        detailsContainer.innerHTML = `<strong>${client.nom} ${client.prenom || ''}</strong><br>${client.adresse || ''}<br>${client.code_postal || ''} ${client.ville || ''}`;
        detailsContainer.style.display = 'block';
        document.getElementById('planning-client-recherche-container').style.display = 'none';
        fermerRechercheClientPlanning();
    }

    function sauvegarderEvenement() {
        if (!planningEventActuel.clientId) { alert("Veuillez sélectionner un client."); return; }
        const eventData = {
            client_id: planningEventActuel.clientId,
            start_datetime: document.getElementById('planning-start-datetime').value,
            work_description: document.getElementById('planning-work-description').value,
            technician_name: document.getElementById('planning-technician-name').value,
            car_registration: document.getElementById('planning-car-registration').value,
        };
        if (!eventData.start_datetime || !eventData.work_description) { alert("La date/heure et la description sont obligatoires."); return; }
        fetch('/api/planning', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(eventData) })
            .then(response => response.ok ? response.json() : response.json().then(err => { throw new Error(err.message); }))
            .then(data => { alert(data.message); fermerModalNouvelEvenement(); chargerEvenementsPlanning(); })
            .catch(error => { console.error("Erreur sauvegarde événement:", error); alert(`Erreur: ${error.message}`); });
    }

    // --- Logique de la nouvelle facture ---
    let factureActuelle = { clientId: null, lignes: [], tvaTaux: 0.20 };

    function afficherFormulaireNouvelleFacture() { // F2 - Nouvelle facture
        showPanel('nouvelle-facture-form');
        // Réinitialiser l'état de la facture
        factureActuelle = { clientId: null, lignes: [], tvaTaux: 0.20 };
        document.getElementById('facture-client-details').style.display = 'none';
        document.getElementById('facture-client-recherche-container').style.display = 'block';
        document.getElementById('facture-recherche-client').value = '';
        document.getElementById('facture-lignes-table').getElementsByTagName('tbody')[0].innerHTML = '';
        document.getElementById('facture-infos-complementaires').value = '';

        // Générer un numéro de facture et la date
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        document.getElementById('facture-numero').innerText = `${year}${month}-${now.getTime().toString().slice(-4)}`;
        document.getElementById('facture-date').innerText = `${day}/${month}/${year}`;
        calculerTotaux();
    }

    function rechercherClientPourFacture() {
        const searchTerm = document.getElementById('facture-recherche-client').value;
        if (searchTerm.length < 2) {
            alert("Veuillez entrer au moins 2 caractères pour rechercher.");
            return;
        }

        const resultsContainer = document.getElementById('resultats-recherche-client-facture');

        fetch(`/api/clients/search?q=${searchTerm}`)
            .then(response => response.json())
            .then(clients => {
                resultsContainer.innerHTML = '';
                if (clients.length === 0) {
                    resultsContainer.innerHTML = '<p>Aucun client trouvé.</p>';
                } else {
                    clients.forEach(client => {
                        const bloc = document.createElement("div");
                        bloc.className = "client-card"; // On réutilise le style de la fiche client
                        bloc.innerHTML = `
                          <p><strong>Nom :</strong> ${client.nom} ${client.prenom || ''}</p>
                          <p><strong>Adresse :</strong> ${client.adresse || 'N/A'}</p>
                          <p><strong>Ville :</strong> ${client.code_postal || ''} ${client.ville || ''}</p>
                          <p><strong>Téléphone :</strong> ${client.telephone || 'N/A'}</p>
                        `;
                        const selectButton = document.createElement('button');
                        selectButton.innerText = 'Sélectionner ce client';
                        selectButton.onclick = () => selectionnerClientPourFacture(client);
                        bloc.appendChild(selectButton);
                        resultsContainer.appendChild(bloc);
                    });
                }
                // Afficher la modale
                document.getElementById('recherche-client-facture-panel').style.display = 'flex';
            }).catch(error => console.error("Erreur de recherche client:", error));
    }

    function selectionnerClientPourFacture(client) {
        factureActuelle.clientId = client.id;
        const detailsContainer = document.getElementById('facture-client-details');
        detailsContainer.innerHTML = `
            <strong>${client.nom} ${client.prenom || ''}</strong><br>
            ${client.adresse || ''}<br>
            ${client.code_postal || ''} ${client.ville || ''}<br>
            Tél: ${client.telephone || 'N/A'}
        `;
        detailsContainer.style.display = 'block';
        document.getElementById('facture-recherche-client').value = '';
        document.getElementById('facture-client-recherche-container').style.display = 'none';

        // Fermer la modale de recherche
        fermerRechercheClientFacture();
    }

    function fermerRechercheClientFacture() {
        document.getElementById('recherche-client-facture-panel').style.display = 'none';
    }

    function ajouterLigne(description, quantite, prix_unitaire_ht, piece_id = null) {
        // Ajoute la ligne à l'état de la facture actuelle
        factureActuelle.lignes.push({ id: Date.now(), description, quantite, prix_unitaire_ht, piece_id });
        // Met à jour l'affichage
        redessinerLignesFacture();
    }

    function redessinerLignesFacture() {
        const tbody = document.getElementById('facture-lignes-table').getElementsByTagName('tbody')[0];
        tbody.innerHTML = '';
        factureActuelle.lignes.forEach(ligne => {
            const tr = document.createElement('tr');
            // NOUVEAU: Les champs sont maintenant des inputs pour être éditables
            tr.innerHTML = `
                <td>${ligne.description}</td>
                <td><input type="number" class="quantity" value="${ligne.quantite}" onchange="updateLigneValue(${ligne.id}, 'quantite', this.value)" style="width: 60px;"></td>
                <td><input type="number" class="price" value="${ligne.prix_unitaire_ht.toFixed(2)}" onchange="updateLigneValue(${ligne.id}, 'prix_unitaire_ht', this.value)" step="0.01" style="width: 80px;"></td>
                <td>${(ligne.quantite * ligne.prix_unitaire_ht).toFixed(2)}</td>
                <td><button onclick="supprimerLigneFacture(${ligne.id})">X</button></td>
            `;
            tbody.appendChild(tr);
        });
        calculerTotaux();
    }
    // NOUVEAU: Fonction pour mettre à jour une valeur dans une ligne de facture
    function updateLigneValue(ligneId, field, newValue) {
        const ligne = factureActuelle.lignes.find(l => l.id === ligneId);
        if (ligne) { ligne[field] = parseFloat(newValue) || 0; }
        redessinerLignesFacture(); // Redessine tout pour recalculer les totaux
    }

    function supprimerLigneFacture(ligneId) {
        factureActuelle.lignes = factureActuelle.lignes.filter(l => l.id !== ligneId);
        redessinerLignesFacture();
    }

    function calculerTotaux() {
        const totalHT = factureActuelle.lignes.reduce((sum, l) => sum + (l.quantite * l.prix_unitaire_ht), 0);
        const tva = totalHT * factureActuelle.tvaTaux;
        const totalTTC = totalHT + tva;
        document.getElementById('facture-total-ht').innerText = totalHT.toFixed(2);
        document.getElementById('facture-tva').innerText = tva.toFixed(2);
        document.getElementById('facture-total-ttc').innerText = totalTTC.toFixed(2);
    }

    // MODIFIÉ: La fonction n'ouvre plus de modale mais ajoute une ligne de recherche
    function ajouterLignePiece() {
        // Empêche d'ajouter une nouvelle ligne de recherche si une est déjà en cours d'édition
        if (document.querySelector('.editing-row')) {
            alert("Veuillez d'abord terminer la saisie de la ligne actuelle.");
            return;
        }

        const tbody = document.getElementById('facture-lignes-table').getElementsByTagName('tbody')[0];
        const tempRow = tbody.insertRow();
        tempRow.className = 'editing-row'; // Marqueur pour la ligne temporaire

        tempRow.innerHTML = `
            <td class="search-container-cell">
                <input type="text" class="description-search-input" placeholder="Chercher pièce par réf. ou nom..." oninput="liveSearchPieces(this)" autocomplete="off">
                <div class="search-results"></div>
            </td>
            <td><input type="number" class="quantity-input" value="1" min="0.1" step="0.1" style="width: 60px;"></td>
            <td><input type="number" class="price-input" placeholder="Prix" disabled style="width: 80px;"></td>
            <td>-</td>
            <td><button type="button" onclick="this.closest('tr').remove()">Annuler</button></td>
        `;
        tempRow.querySelector('.description-search-input').focus();
    }

    // NOUVEAU: Logique de recherche en direct
    async function liveSearchPieces(inputElement) {
        const searchTerm = inputElement.value;
        const resultsContainer = inputElement.nextElementSibling;
        resultsContainer.innerHTML = '';

        if (searchTerm.length < 2) {
            resultsContainer.style.display = 'none';
            return;
        }

        const response = await fetch(`/api/pieces/search?q=${encodeURIComponent(searchTerm)}`);
        const pieces = await response.json();

        resultsContainer.style.display = 'block';
        if (pieces.length > 0) {
            pieces.forEach(piece => {
                const item = document.createElement('div');
                item.className = 'result-item';
                item.textContent = `${piece.designation} (Réf: ${piece.ref || 'N/A'}) - ${piece.prix_vente.toFixed(2)}€`;
                item.onclick = () => selectPieceAndConfirmLine(piece, inputElement);
                resultsContainer.appendChild(item);
            });
        } else {
            resultsContainer.innerHTML = '<div class="result-item-error">Aucune pièce trouvée.</div>';
        }
    }
    
    function fermerRecherchePieceFacture() {
        document.getElementById('recherche-piece-facture-panel').style.display = 'none';
        document.getElementById('recherche-piece-facture-input').value = '';
        document.getElementById('resultats-recherche-piece-facture').innerHTML = '';
    }

    function rechercherPiecePourFacture() {
        const searchTerm = document.getElementById('recherche-piece-facture-input').value;
        const resultsContainer = document.getElementById('resultats-recherche-piece-facture');
        if (searchTerm.length < 2) {
            resultsContainer.innerHTML = '';
            return;
        }

        fetch(`/api/pieces/search?q=${searchTerm}`)
            .then(response => response.json())
            .then(pieces => {
                resultsContainer.innerHTML = '';
                pieces.forEach(piece => {
                    const div = document.createElement('div');
                    div.className = 'resultat-recherche-facture-item';
                    div.innerHTML = `
                        <strong>${piece.designation}</strong> (Réf: ${piece.ref || 'N/A'})<br>
                        <span>Prix de vente: ${piece.prix_vente.toFixed(2)} € HT</span>
                    `;
                    div.onclick = () => selectionnerPiecePourFacture(piece);
                    resultsContainer.appendChild(div);
                });
            }).catch(error => console.error("Erreur de recherche de pièce:", error));
    }

    // MODIFIÉ: La sélection se fait depuis la nouvelle ligne de recherche
    function selectPieceAndConfirmLine(piece, inputElement) {
        const tempRow = inputElement.closest('.editing-row');
        const quantite = parseFloat(tempRow.querySelector('.quantity-input').value);

        if (quantite && !isNaN(quantite) && quantite > 0) {
            ajouterLigne(`${piece.designation} (Réf: ${piece.ref || 'N/A'})`, quantite, piece.prix_vente, piece.id);
        }
        tempRow.remove(); // Supprime la ligne de recherche temporaire
    }

    function ajouterLigneMainDoeuvre() {
        // Ouvre le panneau de recherche de main d'oeuvre
        document.getElementById('recherche-maindoeuvre-facture-panel').style.display = 'flex';
        document.getElementById('recherche-maindoeuvre-facture-input').focus();
    }

    function fermerRechercheMainDoeuvreFacture() {
        document.getElementById('recherche-maindoeuvre-facture-panel').style.display = 'none';
        document.getElementById('recherche-maindoeuvre-facture-input').value = '';
        document.getElementById('resultats-recherche-maindoeuvre-facture').innerHTML = '';
    }

    function rechercherMainDoeuvrePourFacture() {
        const searchTerm = document.getElementById('recherche-maindoeuvre-facture-input').value;
        const resultsContainer = document.getElementById('resultats-recherche-maindoeuvre-facture');
        if (searchTerm.length < 2) {
            resultsContainer.innerHTML = '';
            return;
        }

        fetch(`/api/maindoeuvre/search`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ description: searchTerm })
        })
            .then(response => response.json())
            .then(data => {
                resultsContainer.innerHTML = '';
                const items = data.maindoeuvre; // L'API renvoie un objet {maindoeuvre: [...]}
                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'resultat-recherche-facture-item';
                    div.innerHTML = `
                        <strong>${item.description}</strong><br>
                        <span>Taux horaire: ${item.taux_horaire.toFixed(2)} € HT</span>
                    `;
                    div.onclick = () => selectionnerMainDoeuvrePourFacture(item);
                    resultsContainer.appendChild(div);
                });
            }).catch(error => console.error("Erreur de recherche de main d'oeuvre:", error));
    }

    function selectionnerMainDoeuvrePourFacture(item) {
        const quantite = parseFloat(prompt(`Nombre d'heures pour "${item.description}" ?`, "1"));
        if (quantite && !isNaN(quantite) && quantite > 0) {
            ajouterLigne(item.description, quantite, item.taux_horaire);
            fermerRechercheMainDoeuvreFacture();
        }
    }

    function sauvegarderFacture() {
        if (!factureActuelle.clientId) { alert("Veuillez sélectionner un client."); return; }
        if (factureActuelle.lignes.length === 0) { alert("Veuillez ajouter au moins une ligne à la facture."); return; }

        const data_a_envoyer = {
            numero_facture: document.getElementById('facture-numero').innerText,
            client_id: factureActuelle.clientId,
            informations_complementaires: document.getElementById('facture-infos-complementaires').value,
            lignes: factureActuelle.lignes.map(l => ({
                description: l.description,
                quantite: l.quantite,
                prix_unitaire_ht: l.prix_unitaire_ht,
                piece_id: l.piece_id
            }))
        };

        console.log("Tentative de sauvegarde avec les données suivantes :", JSON.stringify(data_a_envoyer, null, 2));

        fetch("/api/factures", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data_a_envoyer)
        })
        .then(response => {
            console.log("Réponse brute du serveur reçue. Statut:", response.status);
            if (!response.ok) {
                // Si la réponse n'est pas OK, on essaie de lire le texte de l'erreur
                return response.text().then(text => { 
                    throw new Error(`Erreur du serveur (statut ${response.status}): ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log("Données JSON analysées avec succès:", data);
            alert(data.message || "Facture sauvegardée avec succès !");
            
            if (data.facture && data.facture.id) {
                const factureId = data.facture.id;
                document.getElementById('facture-actions-initiales').style.display = 'none';
                document.getElementById('facture-actions-post-sauvegarde').style.display = 'block';
                document.getElementById('btn-imprimer-pdf').onclick = () => imprimerFacture(factureId);
            } else {
                console.error("La réponse du serveur ne contient pas l'ID de la facture.", data);
                alert("La facture a été sauvegardée, mais une erreur est survenue lors de la récupération de son ID. Le bouton PDF ne sera pas disponible.");
            }
        })
        .catch(error => {
            console.error("Erreur détaillée lors de la sauvegarde de la facture:", error);
            alert(`Une erreur est survenue lors de la sauvegarde : ${error.message}. Vérifiez la console pour plus de détails.`);
        });
    }

    function imprimerFacture(factureId) { window.open(`/api/factures/${factureId}/pdf`); }

    function afficherInterfaceFactures() {
      showPanel('facture-options'); // F2 - Factures
    }

    function afficherFormulaireRechercheFacture() {
        showPanel('recherche-facture-form'); // F2 - Recherche de facture
        document.getElementById('resultats-recherche-factures').innerHTML = ''; // Vider les anciens résultats
        document.getElementById('recherche-facture-input').focus();
    }

    function rechercherFacture() {
        const searchTerm = document.getElementById('recherche-facture-input').value;
        if (searchTerm.length < 2) {
            alert("Veuillez entrer au moins 2 caractères pour la recherche.");
            return;
        }

        fetch(`/api/factures/search?q=${searchTerm}`)
            .then(response => {
                if (!response.ok) throw new Error('Erreur réseau lors de la recherche.');
                return response.json();
            })
            .then(factures => {
                afficherResultatsFactures(factures);
            })
            .catch(error => {
                console.error("Erreur lors de la recherche de factures:", error);
                document.getElementById('resultats-recherche-factures').innerHTML = `<p>Une erreur est survenue.</p>`;
            });
    }

    function afficherResultatsFactures(factures) {
        const container = document.getElementById('resultats-recherche-factures');
        container.innerHTML = '';

        if (!factures || factures.length === 0) {
            container.innerHTML = '<p>Aucune facture trouvée pour votre recherche.</p>';
        } else {
            factures.forEach(facture => {
                const bloc = document.createElement('div');
                bloc.className = 'client-card'; // On réutilise le style des fiches
                const clientPrenom = facture.client.prenom || ''; // Gestion du prénom potentiellement absent
                const clientNom = facture.client.nom || '';
                const dateCreation = new Date(facture.date_creation).toLocaleDateString('fr-FR');
                bloc.innerHTML = `
                    <h4>Facture N° ${facture.numero_facture}</h4>
                    <p><strong>Client :</strong> ${clientPrenom.trim()} ${clientNom.trim()}</p>
                    <p><strong>Date :</strong> ${dateCreation}</p>
                    <p><strong>Total TTC :</strong> ${facture.total_ttc.toFixed(2)} €</p>
                    <button onclick="imprimerFacture(${facture.id})">Imprimer PDF</button>
                `;
                container.appendChild(bloc);
            });
        }
        container.style.display = 'block';
    }

    function afficherOptionsClient() { showPanel('client-options'); } // F3 - Clients
    function afficherFormulaireNouveauClient() { // F3 - Nouveau client
      showPanel('nouveau-client-form');
      // Vider le formulaire à chaque affichage pour une nouvelle saisie
      document.getElementById('nouveau-client-form').querySelectorAll('input').forEach(input => input.value = '');
    }
    function afficherFormulaireNouvellePiece() { // F4 - Nouvelle référence
      showPanel('nouveau-piece-form');
      // On charge les fournisseurs dans le menu déroulant à chaque fois qu'on ouvre le formulaire
      populateFournisseursDropdown();
    }
    function afficherFormulaireRecherchePiece() { showPanel('recherche-piece-form'); document.getElementById('resultats-recherche-pieces').innerHTML = ''; } // F4 - Référence connue

    // --- Fonctions de navigation entre les onglets ---

    function afficherInterfacePieces(){
      showPanel('interface-pieces'); // F4 - Pièces
    }

    function afficherAccueil() {
      showPanel('accueil-section'); // F1 - Accueil
    }

    // Fonctions vides pour éviter les erreurs sur les onglets non implémentés
    function afficherInterfaceMaindoeuvre() {
      showPanel('interface-maindoeuvre'); // F5 - Main d'oeuvre
    }

    function afficherInterfaceAnalyse() { alert("Section 'Analyse' non implémentée."); }
    function afficherInterfacePhotos() { alert("Section 'Photos' non implémentée."); }

    // --- GESTION DES CLIENTS ---

    function afficherFormulaireRechercheClient() { // F3 - Client déjà existant
        showPanel('recherche-client-form');
        document.getElementById('resultatsRecherche').style.display = 'block';
        document.getElementById('recherche-client-input').value = '';
        rechercherClient(); // Lance une recherche initiale pour afficher tous les clients
    }

    function rechercherClient() {
        const searchTerm = document.getElementById("recherche-client-input").value;
        // Note: L'API backend doit être adaptée pour gérer une recherche GET sur /api/clients/search?q=...
        fetch(`/api/clients/search?q=${encodeURIComponent(searchTerm)}`)
            .then(response => {
                if (!response.ok) throw new Error(`Erreur réseau: ${response.statusText}`);
                return response.json();
            })
            .then(clients => {
                afficherResultatsClients(clients);
            })
            .catch(error => {
                console.error("Erreur lors de la recherche de client:", error);
                document.getElementById("resultatsRecherche").innerHTML = `<p class="error">Erreur lors de la récupération des clients.</p>`;
            });
    }

    function afficherResultatsClients(clients) {
        const container = document.getElementById("resultatsRecherche");
        container.innerHTML = "";

        if (!clients || clients.length === 0) {
            container.innerHTML = "<p>Aucun client trouvé.</p>";
            return;
        }

        clients.forEach(client => {
            const bloc = document.createElement("div");
            bloc.className = "client-card";
            bloc.innerHTML = `
              <p><strong>Nom :</strong> ${client.nom || ''} ${client.prenom || ''}</p>
              <p><strong>Téléphone :</strong> ${client.telephone || 'N/A'}</p>
              <p><strong>Email :</strong> ${client.email || 'N/A'}</p>
              <p><strong>Adresse :</strong> ${client.adresse || ''}, ${client.code_postal || ''} ${client.ville || ''}</p>
              <button onclick='ouvrirModalModificationClient(${JSON.stringify(client)})'>Modifier</button>
              <button onclick="supprimerClient(${client.id})">Supprimer</button>
            `;
            container.appendChild(bloc);
        });
    }

    function ouvrirModalModificationClient(client) {
        document.getElementById('edit-client-id').value = client.id;
        document.getElementById('edit-nom').value = client.nom || '';
        document.getElementById('edit-prenom').value = client.prenom || '';
        document.getElementById('edit-telephone').value = client.telephone || '';
        document.getElementById('edit-email').value = client.email || '';
        document.getElementById('edit-adresse').value = client.adresse || '';
        document.getElementById('edit-code_postal').value = client.code_postal || '';
        document.getElementById('edit-ville').value = client.ville || '';
        document.getElementById('edit-pays').value = client.pays || '';
        document.getElementById('edit-client-modal').style.display = 'flex';
    }

    function fermerModalModificationClient() {
        document.getElementById('edit-client-modal').style.display = 'none';
    }

    function enregistrerModificationClient() {
        const clientId = document.getElementById("edit-client-id").value;
        const clientData = {
            nom: document.getElementById("edit-nom").value,
            prenom: document.getElementById("edit-prenom").value,
            telephone: document.getElementById("edit-telephone").value,
            email: document.getElementById("edit-email").value,
            adresse: document.getElementById("edit-adresse").value,
            code_postal: document.getElementById("edit-code_postal").value,
            ville: document.getElementById("edit-ville").value,
            pays: document.getElementById("edit-pays").value
        };

        fetch(`/api/clients/${clientId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(clientData)
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            fermerModalModificationClient();
            rechercherClient(); // Rafraîchit la liste pour afficher les modifications
        })
        .catch(error => console.error("Erreur lors de la modification:", error));
    }

    function ajouterClient() {
        const client = {
            nom: document.getElementById("nom").value,
            prenom: document.getElementById("prenom").value,
            telephone: document.getElementById("telephone").value,
            email: document.getElementById("email").value,
            adresse: document.getElementById("adresse").value,
            code_postal: document.getElementById("code_postal").value,
            ville: document.getElementById("ville").value,
            pays: document.getElementById("pays").value
        };

        fetch("/api/clients", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(client)
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            afficherFormulaireRechercheClient(); // Revenir à la liste des clients et la rafraîchir
        })
        .catch(error => console.error("Erreur:", error));
    }

    function supprimerClient(id) {
        if (!confirm("Confirmer la suppression de ce client ? Cette action est irréversible.")) return;
        fetch(`/api/clients/${id}`, {
            method: "DELETE"
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            rechercherClient(); // Rafraîchit la liste après la suppression
        })
        .catch(error => console.error("Erreur:", error));
    }

    // --- Fonctions de gestion des données ---

    function ajouterPiece() {
      const piece = {
        designation: document.getElementById('piece-designation').value.trim(),
        ref: document.getElementById('piece-ref').value.trim(),
        prix_achat: document.getElementById('piece-prix-achat').value,
        prix_vente: document.getElementById('piece-prix-vente').value, 
        category: document.getElementById('piece-category').value.trim(), // NOUVEAU
        fournisseur_id: document.getElementById('piece-fournisseur').value
      };

      // Validation côté client
      if (!piece.designation) {
        alert("La désignation est obligatoire.");
        return;
      }
      if (!piece.prix_vente || isNaN(parseFloat(piece.prix_vente)) || parseFloat(piece.prix_vente) <= 0) {
        alert("Le prix de vente doit être un nombre positif.");
        return;
      }
      if (piece.prix_achat && (isNaN(parseFloat(piece.prix_achat)) || parseFloat(piece.prix_achat) < 0)) {
        alert("Le prix d'achat doit être un nombre positif ou nul.");
        return;
      }
      if (!piece.fournisseur_id) {
        alert("Veuillez sélectionner un fournisseur.");
        return;
      }

      // Convertir les valeurs numériques
      piece.prix_achat = piece.prix_achat ? parseFloat(piece.prix_achat) : null;
      piece.prix_vente = parseFloat(piece.prix_vente);
      piece.fournisseur_id = parseInt(piece.fournisseur_id);

      fetch("/api/pieces", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(piece)
      })
      .then(response => response.ok ? response.json() : response.json().then(err => { throw new Error(err.message || `Erreur serveur: ${response.status}`); }))
      .then(data => {
        alert(data.message || "Pièce ajoutée avec succès !");
        document.getElementById('nouveau-piece-form').querySelectorAll('input, select').forEach(element => element.value = ''); // Vide tous les champs
        afficherInterfacePieces(); // Revenir à l'écran principal des pièces
      })
      .catch(error => console.error("Erreur lors de l'ajout de la pièce:", error));
    }

    function rechercherPiece() {
      const designation = document.getElementById('recherche-piece-designation').value;
      const ref = document.getElementById('recherche-piece-ref').value;

      fetch("/api/pieces/search", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ designation, ref })
      })
      .then(response => response.json())
      .then(data => afficherResultatsPieces(data.pieces))
      .catch(error => console.error("Erreur lors de la recherche de pièces:", error));
    }

    function afficherResultatsPieces(pieces) {
      const container = document.getElementById("resultats-recherche-pieces");
      container.innerHTML = ""; // Vider les anciens résultats
      document.getElementById('recherche-piece-form').style.display = 'block'; // Garder le formulaire de recherche visible

      if (!pieces || pieces.length === 0) {
          container.innerHTML = "<p>Aucune pièce trouvée.</p>";
      } else {
          pieces.forEach(piece => {
              const bloc = document.createElement("div");
              bloc.className = "client-card"; // On réutilise le même style
              bloc.innerHTML = `
                  <p><strong>Désignation :</strong> ${piece.designation}</p>
                  <p><strong>Référence :</strong> ${piece.ref || 'N/A'}</p>
                  <p><strong>Prix Achat HT :</strong> ${piece.prix_achat !== null ? piece.prix_achat.toFixed(2) + ' €' : 'N/A'}</p>
                  <p><strong>Prix Vente HT :</strong> ${piece.prix_vente.toFixed(2)} €</p>
              `;
              container.appendChild(bloc);
          });
      }
      container.style.display = "block";
    }

    function testerBackendPieces() {
     fetch("/api/pieces")
    .then(response => response.json())
    .then(data => alert("Réponse backend : " + data.message))
    .catch(error => alert("Erreur de connexion au backend : " + error));
}

    // --- NOUVEAU: Fonctions pour la Main d'oeuvre ---

    function afficherFormulaireNouvelleMainDoeuvre() { showPanel('nouveau-maindoeuvre-form'); } // F5 - Nouveau type
    function afficherFormulaireRechercheMainDoeuvre() { showPanel('recherche-maindoeuvre-form'); document.getElementById('resultats-recherche-maindoeuvre').innerHTML = ''; } // F5 - Rechercher un type

    function ajouterMainDoeuvre() {
      const maindoeuvre = {
        description: document.getElementById('maindoeuvre-description').value,
        taux_horaire: document.getElementById('maindoeuvre-taux-horaire').value
      };

      if (!maindoeuvre.description || !maindoeuvre.taux_horaire) {
        alert("La description et le taux horaire sont obligatoires.");
        return;
      }

      fetch("/api/maindoeuvre", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(maindoeuvre)
      })
      .then(response => {
        // Gère les réponses d'erreur du serveur (comme les doublons)
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.message) });
        }
        return response.json();
      })
      .then(data => {
        alert(data.message || "Type de main d'oeuvre ajouté avec succès !");
        // Correction: .reset() ne fonctionne que sur les <form>, on vide les champs manuellement.
        document.getElementById('maindoeuvre-description').value = '';
        document.getElementById('maindoeuvre-taux-horaire').value = '';
        // Vider le champ de recherche pour s'assurer d'afficher tous les résultats
        document.getElementById('recherche-maindoeuvre-description').value = '';
        // Lancer une recherche pour rafraîchir la liste et l'afficher
        rechercherMainDoeuvre();
      })
      .catch(error => {
          console.error("Erreur lors de l'ajout de la main d'oeuvre:", error);
          alert(error.message); // Affiche le message d'erreur spécifique à l'utilisateur
      });
    }

    function rechercherMainDoeuvre() {
      const description = document.getElementById('recherche-maindoeuvre-description').value;
      fetch("/api/maindoeuvre/search", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ description })
      })
      .then(response => response.json())
      .then(data => afficherResultatsMainDoeuvre(data.maindoeuvre))
      .catch(error => console.error("Erreur lors de la recherche de main d'oeuvre:", error));
    }

    function afficherResultatsMainDoeuvre(items) {
      const container = document.getElementById("resultats-recherche-maindoeuvre");
      container.innerHTML = ""; // Vider les anciens résultats
      document.getElementById('recherche-maindoeuvre-form').style.display = 'block';

      if (!items || items.length === 0) {
          container.innerHTML = "<p>Aucun type de main d'oeuvre trouvé.</p>";
      } else {
          items.forEach(item => {
              const bloc = document.createElement("div");
              bloc.className = "client-card";
              bloc.innerHTML = `
                <p><strong>Description :</strong> ${item.description}</p>
                <p><strong>Taux horaire HT :</strong> ${item.taux_horaire.toFixed(2)} €</p>
                <button onclick="supprimerMainDoeuvre(${item.id})">Supprimer</button>
                <button onclick='modifierMainDoeuvre(${JSON.stringify(item)})'>Modifier</button>
              `;
              container.appendChild(bloc);
          });
      }
      container.style.display = "block";
    }

    function supprimerMainDoeuvre(id) {
        if (!confirm("Confirmer la suppression de ce type de main d'oeuvre ?")) return;
        fetch(`/api/maindoeuvre/${id}`, {
            method: "DELETE"
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.message) });
            }
            return response.json();
        })
        .then(data => {
            alert(data.message);
            rechercherMainDoeuvre(); // Rafraîchit la liste
        })
        .catch(error => {
            console.error("Erreur lors de la suppression:", error);
            alert(error.message);
        });
    }

    function modifierMainDoeuvre(item) {
        const container = document.getElementById("resultats-recherche-maindoeuvre");
        container.innerHTML = ""; // Vide les résultats précédents

        const form = document.createElement("div");
        form.className = "client-card";
        form.innerHTML = `
          <h3>Modifier le type de main d'oeuvre</h3>
          <div class="form-group">
            <label for="edit-maindoeuvre-description">Description</label>
            <input type="text" id="edit-maindoeuvre-description" value="${item.description}">
          </div>
          <div class="form-group">
            <label for="edit-maindoeuvre-taux">Taux horaire HT</label>
            <input type="number" id="edit-maindoeuvre-taux" value="${item.taux_horaire.toFixed(2)}" step="0.01">
          </div>
          <button onclick="enregistrerModificationMainDoeuvre(${item.id})">Enregistrer</button>
          <button onclick="rechercherMainDoeuvre()">Annuler</button>
        `;
        container.appendChild(form);
    }

    function enregistrerModificationMainDoeuvre(id) {
        const data = {
            description: document.getElementById("edit-maindoeuvre-description").value,
            taux_horaire: document.getElementById("edit-maindoeuvre-taux").value
        };

        if (!data.description || !data.taux_horaire) {
            alert("La description et le taux horaire sont obligatoires.");
            return;
        }

        fetch(`/api/maindoeuvre/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.message) });
            }
            return response.json();
        })
        .then(data => {
            alert(data.message);
            rechercherMainDoeuvre(); // Rafraîchit la liste
        })
        .catch(error => {
            console.error("Erreur lors de la modification:", error);
            alert(error.message);
        });
    }

    // --- NOUVEAU: Fonctions pour les onglets non implémentés ---
    function afficherInterfaceNotifications() { alert("Section 'Notifications' non implémentée."); }
    function afficherInterfaceParametre() { showPanel('interface-technicien'); }
    function afficherFormulaireNouveauTechnicien() { showPanel('nouveau-technicien-form'); }
    function afficherListeTechniciens() { alert("Fonctionnalité 'Liste des Techniciens' non implémentée."); }
    function ajouterTechnicien() {
        const technicienData = {
            nom: document.getElementById('tech-nom').value.trim(),
            prenom: document.getElementById('tech-prenom').value.trim(),
            adresse: document.getElementById('tech-adresse').value.trim(),
            code_postal: document.getElementById('tech-code-postal').value.trim(),
            ville: document.getElementById('tech-ville').value.trim(),
            date_naissance: document.getElementById('tech-date-naissance').value,
            email: document.getElementById('tech-email').value.trim(),
            telephone: document.getElementById('tech-telephone').value.trim(),
            numero_technicien: document.getElementById('tech-numero').value.trim()
        };

        // Validation côté client
        if (!technicienData.nom || !technicienData.prenom || !technicienData.numero_technicien) {
            alert("Les champs Nom, Prénom et Numéro de technicien sont obligatoires.");
            return;
        }

        fetch('/api/techniciens', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(technicienData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.message || 'Une erreur est survenue.'); });
            }
            return response.json();
        })
        .then(data => {
            alert(data.message || "Technicien ajouté avec succès !");
            document.getElementById('nouveau-technicien-form').querySelectorAll('input').forEach(input => input.value = '');
            afficherInterfaceParametre(); // Revenir au menu technicien
        })
        .catch(error => {
            console.error("Erreur lors de l'ajout du technicien:", error);
            alert(`Erreur: ${error.message}`);
        });
    }

    function afficherInterfaceOptions() { showPanel('interface-options'); } // F11 - Option

    // --- GESTION DES RACCOURCIS CLAVIER (F1, F2, etc.) ---
    document.addEventListener('keydown', function(event) {
        // On utilise un switch pour gérer les différentes touches
        switch (event.key) {
            case 'F1':
                event.preventDefault(); // Empêche l'action par défaut du navigateur (ouvrir l'aide)
                afficherAccueil();
                break;
            case 'F2':
                event.preventDefault();
                afficherInterfaceFactures();
                break;
            case 'F3':
                event.preventDefault();
                afficherOptionsClient();
                break;
            case 'F4':
                event.preventDefault();
                afficherInterfacePieces();
                break;
            case 'F5':
                event.preventDefault();
                afficherInterfaceMaindoeuvre();
                break;
            case 'F6': event.preventDefault(); afficherInterfaceAnalyse(); break;
            case 'F7': event.preventDefault(); afficherInterfacePhotos(); break; 
            case 'F8': event.preventDefault(); afficherInterfacePlanning(); break; // Anciennement F9
            case 'F9': event.preventDefault(); afficherInterfaceNotifications(); break; // NOUVEAU
            case 'F10': event.preventDefault(); afficherInterfaceParametre(); break; // NOUVEAU
            case 'F11': event.preventDefault(); afficherInterfaceOptions(); break; // Anciennement F8
            case 'F12':
                if (event.shiftKey) { // Détecte Shift + F12
                    event.preventDefault();
                    afficherInterfaceComptabilite();
                }
                break;
            case 'Escape': goBack(); break; // Utilise 'Escape' pour la touche Échap
        }
    });

    // --- NOUVEAU: Horloge dynamique sur la page d'accueil ---
    function updateDateTime() {
        const now = new Date();
        const targetElement = document.getElementById('date-heure-accueil');

        if (targetElement) {
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };

            const formattedDate = now.toLocaleDateString('fr-FR', dateOptions);
            const formattedTime = now.toLocaleTimeString('fr-FR', timeOptions);

            // Met la première lettre du jour en majuscule
            const finalDate = formattedDate.charAt(0).toUpperCase() + formattedDate.slice(1);

            targetElement.innerText = `${finalDate} - ${formattedTime}`;
        }
    }

  // Afficher l'accueil et démarrer l'horloge au chargement de la page
  window.onload = function() {
      afficherAccueil();
      updateDateTime(); // Affiche l'heure immédiatement
      setInterval(updateDateTime, 1000); // Met à jour l'heure chaque seconde
  };

  // --- NOUVEAU: Fonction pour populer le menu déroulant des fournisseurs dans le formulaire de pièce ---
  function populateFournisseursDropdown() {
      const selectElement = document.getElementById('piece-fournisseur');
      selectElement.innerHTML = '<option value="">Chargement...</option>'; // État initial de chargement

      fetch(`/api/fournisseurs`)
          .then(response => {
              if (!response.ok) {
                  throw new Error(`Erreur réseau lors du chargement des fournisseurs: ${response.statusText}`);
              }
              return response.json();
          })
          .then(fournisseurs => {
              selectElement.innerHTML = '<option value="">-- Sélectionner un fournisseur --</option>'; // Option par défaut
              fournisseurs.forEach(fournisseur => {
                  const option = document.createElement('option');
                  option.value = fournisseur.id;
                  option.innerText = fournisseur.nom;
                  selectElement.appendChild(option);
              });
          })
          .catch(error => {
              console.error("Erreur lors du chargement des fournisseurs pour le formulaire de pièce:", error);
              selectElement.innerHTML = '<option value="">Erreur de chargement</option>';
          });
  }

  // --- NOUVEAU: Fonctions pour l'interface de comptabilité ---

  function afficherInterfaceComptabilite() {
      showPanel('interface-comptabilite');
      chargerDonneesComptabilite();
  }

  function chargerDonneesComptabilite() {
      // Réinitialise l'affichage
      document.getElementById('ca-mois-total').innerText = 'Chargement...';
      document.getElementById('depenses-fournisseur-container').innerHTML = 'Chargement...';
      document.getElementById('ca-famille-piece-container').innerHTML = 'Chargement...';

      // Récupère le CA du mois en cours
      fetch('/api/comptabilite/ca-mensuel')
          .then(response => response.json())
          .then(data => {
              const total = data.total_ca_mensuel || 0;
              document.getElementById('ca-mois-total').innerText = `${total.toFixed(2)} €`;
          })
          .catch(error => {
              console.error("Erreur chargement CA mensuel:", error);
              document.getElementById('ca-mois-total').innerText = 'Erreur';
          });

      // Récupère les dépenses par fournisseur
      fetch('/api/comptabilite/depenses-par-fournisseur')
          .then(response => response.json())
          .then(data => renderTable('depenses-fournisseur-container', ['Fournisseur', 'Montant Dépensé HT'], data, item => [item.nom_fournisseur, `${item.total_depense.toFixed(2)} €`]))
          .catch(error => {
              console.error("Erreur chargement dépenses fournisseur:", error);
              document.getElementById('depenses-fournisseur-container').innerHTML = '<p>Erreur de chargement. <strong>Note:</strong> Cette fonctionnalité nécessite que les pièces soient liées à un fournisseur.</p>';
          });

      // Récupère le CA par famille de pièces
      fetch('/api/comptabilite/ca-par-categorie')
          .then(response => {
              if (!response.ok) {
                  // If response is not OK (e.g., 404, 500), try to read it as text
                  // to get more details about the server's error.
                  return response.text().then(text => {
                      throw new Error(`Server responded with status ${response.status}: ${text.substring(0, 200)}...`); // Limit text length for display
                  });
              }
              return response.json();
          })
          .then(data => {
              // On vérifie si les données sont directement un tableau ou contenues dans une propriété (ex: "data", "results", "categories")
              const dataArray = Array.isArray(data) ? data : data.data || data.results || data.categories || [];
              if (!Array.isArray(data) && dataArray.length === 0) {
                  // Cette ligne est utile pour le débogage dans la console du navigateur
                  console.warn("La réponse de l'API pour 'ca-par-categorie' n'est pas un tableau et ne contient pas de clé de données connue. Réponse reçue:", data);
              }
              renderTable('ca-famille-piece-container', ['Famille de Pièce', 'Chiffre d\'Affaires HT'], dataArray, item => [item.categorie, `${item.total_ca.toFixed(2)} €`]);
          })
          .catch(error => {
              console.error("Erreur chargement CA par catégorie:", error);
              document.getElementById('ca-famille-piece-container').innerHTML = '<p>Erreur de chargement. <strong>Note:</strong> Cette fonctionnalité nécessite que les pièces aient une catégorie.</p>';
          });
  }

  function renderTable(containerId, headers, data, rowMapper) {
      const container = document.getElementById(containerId);
      if (!data || data.length === 0) {
          container.innerHTML = '<p>Aucune donnée disponible.</p>';
          return;
      }
      const table = document.createElement('table');
      table.className = 'compta-table';
      const thead = table.createTHead();
      const headerRow = thead.insertRow();
      headers.forEach(headerText => { const th = document.createElement('th'); th.innerText = headerText; headerRow.appendChild(th); });
      const tbody = table.createTBody();
      data.forEach(item => { const row = tbody.insertRow(); const rowData = rowMapper(item); rowData.forEach(cellData => { const cell = row.insertCell(); cell.innerText = cellData; }); });
      container.innerHTML = '';
      container.appendChild(table);
  }
    // --- Horloge dynamique ---
    function updateDateHeure() {
      const el = document.getElementById("date-heure-accueil");
      const now = new Date();
      const dateOpt = { weekday: "long", year: "numeric", month: "long", day: "numeric" };
      const timeOpt = { hour: "2-digit", minute: "2-digit", second: "2-digit" };
      const d = now.toLocaleDateString("fr-FR", dateOpt);
      const t = now.toLocaleTimeString("fr-FR", timeOpt);
      el.textContent = d.charAt(0).toUpperCase() + d.slice(1) + " – " + t;
    }
    setInterval(updateDateHeure, 1000);
    updateDateHeure();

    // --- Chargement du planning du jour ---
    function loadPlanningDuJour() {
      const container = document.getElementById("planning-jour-container");
      const today = new Date().toISOString().split("T")[0];
      fetch(`/api/planning?start_date=${today}&end_date=${today}`)
        .then(r => r.json())
        .then(events => {
          if (!events.length) {
            container.innerHTML = "<p>Aucun rendez-vous aujourd'hui.</p>";
            return;
          }
          events.sort((a, b) => new Date(a.start_datetime) - new Date(b.start_datetime));
          container.innerHTML = events.map(ev => {
            const d = new Date(ev.start_datetime);
            const hh = ("0" + d.getHours()).slice(-2);
            const mm = ("0" + d.getMinutes()).slice(-2);
            return `<div class="item"><span class="item-time">${hh}:${mm}</span> ${ev.client.nom} – ${ev.work_description}</div>`;
          }).join("");
        })
        .catch(() => container.innerHTML = "<p>Erreur de chargement.</p>");
    }

    // --- Chargement de l'objectif CA du jour ---
    function loadObjectifCA() {
      const container = document.getElementById("objectif-ca-container");
      const today = new Date().toISOString().split("T")[0];
      fetch(`/api/comptabilite/objectif-ca?date=${today}`)
        .then(r => r.json())
        .then(data => {
          container.textContent = data.objectif_ca ? `${data.objectif_ca.toFixed(2)} €` : "Non défini";
        })
        .catch(() => container.textContent = "Erreur");
    }

    // Initialisation au chargement
    window.addEventListener("load", () => {
      updateDateHeure();
      loadPlanningDuJour();
      loadObjectifCA();
    });
</script>


</div></body></html>