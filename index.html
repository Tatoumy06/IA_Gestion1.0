<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>IA Gestion Entreprise Démo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f2f2f2;
    }
    .tabs {
      background: #d6d6d6;
      display: flex;
      border-bottom: 2px solid lightskyblue;
    }
    .tabs div {
      padding: 10px 20px;
      border-right: 1px solid lightskyblue;
      font-weight: bold;
      cursor: pointer;
      color: black
    }
    .main {
      display: flex;
      height: calc(100vh - 50px);
    }
    .content {
      flex: 1;
      padding: 20px;
    }

  .sidebar {
  position: fixed;
  top: 50px; /* distance du haut */
  right: 0; /* collé au bord droit */
  width: 180px;
  background: #eee;
  padding: 20px;
  border-left: 1px solid lightskyblue;
  display: flex;
  flex-direction: column;
  align-items: stretch;
  z-index: 999;
}
  .sidebar button {
    width: auto;
    margin: 0;
    padding: 10px;
    }

    .sidebar button {
      display: block;
      width: 100%;
      margin-bottom: 10px;
      padding: 10px;
      border: none;
      background: #ccc;
      cursor: pointer;
    }
    .form-group {
      margin-bottom: 10px;
    }
    .form-group label {
      display: block;
      margin-bottom: 4px;
      font-size: 14px;
    }
    .form-group input {
      width: 100%;
      padding: 6px;
      border: 1px solid #999;
    }
    .footer {
      display: flex;
      justify-content: space-between;
      background: #d6d6d6;
      padding: 10px;
      border-top: 2px solid #999;
    }
    .footer button {
      padding: 10px 20px;
      border: none;
      background: #bbb;
      cursor: pointer;
    }
     #client-options, #nouveau-client-form, #recherche-client-form, #resultatsRecherche, #interface-pieces, #accueil-section, #nouveau-piece-form, #recherche-piece-form, #resultats-recherche-pieces, #facture-options, #nouvelle-facture-form, #interface-maindoeuvre, #nouveau-maindoeuvre-form, #recherche-maindoeuvre-form, #resultats-recherche-maindoeuvre {
      display: none;
    }
       /* NOUVEAU: Style pour la section d'accueil avec image de fond */
    #accueil-section {
      position: relative; /* Nécessaire pour positionner le voile sombre */
      height: 100%; /* Prend toute la hauteur disponible */
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-image: url('drawable/logo.png'); /* Chemin relatif correct vers votre logo */
      background-size: contain; /* Affiche l'image entièrement, sans la couper */
      background-repeat: no-repeat; /* Empêche l'image de se répéter */
      background-position: center; /* L'image est centrée */
      text-align: center;
   /* Le voile sombre et le texte blanc ont été retirés, car ils ne sont plus nécessaires. */
    }
    .client-card {
      background: white;
      border: 1px solid #ccc;
      margin-bottom: 10px;
      padding: 10px;
    }
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    .modal-content {
        background: white;
        padding: 20px;
        border-radius: 5px;
        width: 500px;
        max-height: 80vh;
        overflow-y: auto;
    }
    .resultat-recherche-facture-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; }
    .resultat-recherche-facture-item:hover { background-color: #f0f0f0; }
    #nouvelle-facture-form {
        background: white;
        padding: 20px;
        border: 1px solid #ddd;
    }
    .facture-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #333;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    .facture-client-section, .facture-lignes-section, .facture-notes-section, .facture-totaux-section, .facture-actions {
        margin-bottom: 20px;
    }
    #facture-lignes-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 10px;
    }
    #facture-lignes-table th, #facture-lignes-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }
    #facture-lignes-table th {
        background-color: #f2f2f2;
    }
    .facture-totaux-section {
        width: 300px;
        margin-left: auto;
        padding: 10px;
        border: 1px solid #ccc;
        background: #f9f9f9;
    }
    .total-ligne {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }
    .total-final {
        font-weight: bold;
        font-size: 1.2em;
        border-top: 1px solid #999;
        padding-top: 5px;
    }
    #facture-resultats-recherche-client .resultat-client { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; }
    #facture-resultats-recherche-client .resultat-client:hover { background-color: #f0f0f0; }
    .facture-search-container {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    .facture-search-container input {
        flex-grow: 1;
    }
    #facture-infos-complementaires { width: 100%; padding: 6px; border: 1px solid #999; }
  </style>
</head>
<body>
  <div class="tabs">
    <div onclick="afficherAccueil()">F1 - Accueil</div>
    <div onclick="afficherInterfaceFactures()">F2 - Factures</div>
    <div onclick="afficherOptionsClient()">F3 - Clients</div>
    <div onclick="afficherInterfacePieces()">F4 - Pièces</div>
    <div onclick="afficherInterfaceMaindoeuvre()">F5 - Main d'oeuvre</div>
    <div onclick="afficherInterfaceAnalyse()">F6 - Analyse</div>
    <div onclick="afficherInterfacePhotos()">F7 - Photos</div>
    <div onclick="afficherInterfaceOptions()">F8 - Options</div>
  </div>

    <div class="main">
    <div class="content">
      <div id="facture-options">
        <h2>Facturation</h2>
        <button onclick="afficherFormulaireNouvelleFacture()">Nouvelle facture</button>
        <button onclick="afficherFormulaireRechercheFacture()">Recherche de facture</button>
      </div>

      <!-- NOUVEAUX BLOCS POUR LA RECHERCHE DE FACTURE -->
      <div id="recherche-facture-form" style="display: none;">
        <h2>Rechercher une facture</h2>
        <div class="form-group">
            <input type="text" id="recherche-facture-input" placeholder="Entrez un N° de facture, un nom de client...">
            <button onclick="rechercherFacture()">Rechercher</button>
        </div>
      </div>
      <div id="resultats-recherche-factures"></div>

      <!-- MODAL/PANEL de recherche de CLIENT pour la facture -->
      <div id="recherche-client-facture-panel" class="modal-overlay" style="display: none;">
          <div class="modal-content">
              <h3>Résultats de la recherche client</h3>
              <div id="resultats-recherche-client-facture"></div>
              <button onclick="fermerRechercheClientFacture()">Fermer</button>
          </div>
      </div>

      <!-- MODAL/PANEL de recherche de pièce pour la facture -->
      <div id="recherche-piece-facture-panel" class="modal-overlay" style="display: none;">
          <div class="modal-content">
              <h3>Rechercher et ajouter une pièce</h3>
              <input type="text" id="recherche-piece-facture-input" onkeyup="rechercherPiecePourFacture()" placeholder="Rechercher par désignation ou référence...">
              <div id="resultats-recherche-piece-facture"></div>
              <button onclick="fermerRecherchePieceFacture()">Fermer</button>
          </div>
      </div>

       <!-- NOUVEAU: MODAL/PANEL de recherche de Main d'oeuvre pour la facture -->
      <div id="recherche-maindoeuvre-facture-panel" class="modal-overlay" style="display: none;">
          <div class="modal-content">
              <h3>Rechercher et ajouter de la Main d'oeuvre</h3>
              <input type="text" id="recherche-maindoeuvre-facture-input" onkeyup="rechercherMainDoeuvrePourFacture()" placeholder="Rechercher par description...">
              <div id="resultats-recherche-maindoeuvre-facture"></div>
              <button onclick="fermerRechercheMainDoeuvreFacture()">Fermer</button>
          </div>
      </div>

      <!-- NOUVEAU: MODAL/PANEL pour la modification d'un client -->
      <div id="edit-client-modal" class="modal-overlay" style="display: none;">
          <div class="modal-content">
              <h3>Modifier le client</h3>
              <input type="hidden" id="edit-client-id">
              <div class="form-group"><label for="edit-nom">Nom</label><input type="text" id="edit-nom"></div>
              <div class="form-group"><label for="edit-prenom">Prénom</label><input type="text" id="edit-prenom"></div>
              <div class="form-group"><label for="edit-telephone">Téléphone</label><input type="text" id="edit-telephone"></div>
              <div class="form-group"><label for="edit-email">Email</label><input type="email" id="edit-email"></div>
              <div class="form-group"><label for="edit-adresse">Adresse</label><input type="text" id="edit-adresse"></div>
              <div class="form-group"><label for="edit-code_postal">Code Postal</label><input type="text" id="edit-code_postal"></div>
              <div class="form-group"><label for="edit-ville">Ville</label><input type="text" id="edit-ville"></div>
              <div class="form-group"><label for="edit-pays">Pays</label><input type="text" id="edit-pays"></div>
              <button type="button" onclick="enregistrerModificationClient()">Sauvegarder</button>
              <button type="button" onclick="fermerModalModificationClient()">Annuler</button>
          </div>
      
      </div>

      <div id="nouvelle-facture-form">
          <div class="facture-header">
              <h2>Nouvelle Facture N° <span id="facture-numero"></span></h2>
              <div class="facture-date">Date: <span id="facture-date"></span></div>
          </div>

          <div class="facture-client-section">
              <h3>Client</h3>
              <div id="facture-client-details" class="client-card" style="display: none;"></div>
              <div id="facture-client-recherche-container">
                  <div class="facture-search-container">
                      <input type="text" id="facture-recherche-client" placeholder="Rechercher un client par nom...">
                      <button onclick="rechercherClientPourFacture()">Rechercher</button>
                  </div>
              </div>
          </div>

          <div class="facture-lignes-section">
              <h3>Détails de la facture</h3>
              <table id="facture-lignes-table">
                  <thead>
                      <tr><th>Description</th><th>Quantité</th><th>Prix U. HT</th><th>Total HT</th><th>Action</th></tr>
                  </thead>
                  <tbody></tbody>
              </table>
              <button onclick="ajouterLignePiece()">Ajouter une pièce</button>
              <button onclick="ajouterLigneMainDoeuvre()">Ajouter Main d'oeuvre</button>
          </div>

          <div class="facture-notes-section">
              <h3>Informations complémentaires</h3>
              <textarea id="facture-infos-complementaires" rows="4"></textarea>
          </div>

          <div class="facture-totaux-section">
              <div class="total-ligne"><span>Total HT :</span> <span id="facture-total-ht">0.00</span> €</div>
              <div class="total-ligne"><span>TVA (20%) :</span> <span id="facture-tva">0.00</span> €</div>
              <div class="total-ligne total-final"><span>TOTAL TTC :</span> <span id="facture-total-ttc">0.00</span> €</div>
          </div>

          <div class="facture-actions" id="facture-actions-initiales"><button onclick="sauvegarderFacture()">Sauvegarder la Facture</button></div>
          <div class="facture-actions" id="facture-actions-post-sauvegarde" style="display:none;"><button id="btn-imprimer-pdf">Imprimer en PDF</button></div>
      </div>

      <div id="client-options">
        <h2>Client</h2>
        <button onclick="afficherFormulaireNouveauClient()">Nouveau client</button>
        <button onclick="afficherFormulaireRechercheClient()">Client déjà existant</button>
      </div>

      <div id="nouveau-client-form">
        <h2>Ajouter un nouveau client</h2>
        <div class="form-group"><label for="nom">Nom</label><input type="text" id="nom"></div>
        <div class="form-group"><label for="prenom">Prénom</label><input type="text" id="prenom"></div>
        <div class="form-group"><label for="telephone">Téléphone</label><input type="text" id="telephone"></div>
        <div class="form-group"><label for="email">Email</label><input type="email" id="email"></div>
        <div class="form-group"><label for="adresse">Adresse</label><input type="text" id="adresse"></div>
        <div class="form-group"><label for="code_postal">Code Postal</label><input type="text" id="code_postal"></div>
        <div class="form-group"><label for="ville">Ville</label><input type="text" id="ville"></div>
        <div class="form-group"><label for="pays">Pays</label><input type="text" id="pays"></div>
        <button onclick="ajouterClient()">Sauvegarder</button>
      </div>

      <div id="recherche-client-form">
        <h2>Rechercher un client</h2>
        <div class="form-group">
            <input type="text" id="recherche-client-input" onkeyup="rechercherClient()" placeholder="Rechercher par nom, prénom, email, etc.">
        </div>
      </div>

      <div id="resultatsRecherche"></div>

      <div id="interface-pieces">
        <h2>Gestion des pièces</h2>
        <button onclick="afficherFormulaireNouvellePiece()">Nouvelle référence</button>
        <button onclick="afficherFormulaireRecherchePiece()">Référence connue</button>
      </div>

      <div id="nouveau-piece-form">
        <h2>Ajouter une nouvelle pièce</h2>
        <div class="form-group"><label for="piece-designation">Désignation</label><input type="text" id="piece-designation"></div>
        <div class="form-group"><label for="piece-ref">Réf.</label><input type="text" id="piece-ref"></div>
        <div class="form-group"><label for="piece-prix-achat">Prix d'achat unitaire HT</label><input type="number" id="piece-prix-achat" step="0.01" placeholder="0.00"></div>
        <div class="form-group"><label for="piece-prix-vente">Prix de vente HT</label><input type="number" id="piece-prix-vente" step="0.01" placeholder="0.00"></div>
        <button onclick="ajouterPiece()">Sauvegarder</button>
      </div>

      <div id="recherche-piece-form">
        <h2>Rechercher une pièce</h2>
        <input type="text" id="recherche-piece-designation" placeholder="Désignation">
        <input type="text" id="recherche-piece-ref" placeholder="Référence">
        <button onclick="rechercherPiece()">Rechercher</button>
      </div>

      <div id="resultats-recherche-pieces"></div>

      <!-- NOUVEAU: Interface Main d'oeuvre -->
      <div id="interface-maindoeuvre">
        <h2>Gestion de la main d'oeuvre</h2>
        <button onclick="afficherFormulaireNouvelleMainDoeuvre()">Nouveau type</button>
        <button onclick="afficherFormulaireRechercheMainDoeuvre()">Rechercher un type</button>
      </div>

      <div id="nouveau-maindoeuvre-form">
        <h2>Ajouter un type de main d'oeuvre</h2>
        <div class="form-group"><label for="maindoeuvre-description">Description</label><input type="text" id="maindoeuvre-description"></div>
        <div class="form-group"><label for="maindoeuvre-taux-horaire">Taux horaire HT</label><input type="number" id="maindoeuvre-taux-horaire" step="0.01" placeholder="0.00"></div>
        <button onclick="ajouterMainDoeuvre()">Sauvegarder</button>
      </div>

      <div id="recherche-maindoeuvre-form">
        <h2>Rechercher un type de main d'oeuvre</h2>
        <input type="text" id="recherche-maindoeuvre-description" placeholder="Description">
        <button onclick="rechercherMainDoeuvre()">Rechercher</button>
      </div>

      <div id="resultats-recherche-maindoeuvre"></div>

      <div id="accueil-section">
        <h2>Bienvenue dans l'application IA Gestion</h2>
        <p>Utilisez les onglets pour naviguer entre les différentes sections de gestion.</p>
      </div>
    </div>

    <div class="sidebar">
      <button>Retour</button>
      <button>Notification</button>
      <button>Paramètre</button>
      <button>Comptabilité</button>
    </div>
  </div>

  <div class="footer">
    <button>Impr. tout</button>
    <button>Impr. client</button>
  </div>

  <script>
    // Renommé pour plus de clarté : cache tous les panneaux de contenu principaux
    function hideAllContentPanels() {
        const panelIds = [
            'accueil-section', 'client-options', 'nouveau-client-form', 'nouveau-piece-form', 'recherche-piece-form', 'resultats-recherche-pieces',
            'facture-options', 'nouvelle-facture-form', 'recherche-facture-form', 'resultats-recherche-factures', 'interface-maindoeuvre', 
            'nouveau-maindoeuvre-form', 'recherche-maindoeuvre-form', 'resultats-recherche-maindoeuvre',
            'recherche-client-form', 'resultatsRecherche', 'interface-pieces'
        ];
        panelIds.forEach(id => {
            const panel = document.getElementById(id);
            if (panel) panel.style.display = 'none';
        });
    }

    // Variable globale pour stocker l'historique des panneaux de contenu principaux
    let panelHistory = [];
    const MAX_HISTORY_SIZE = 10; // Limite l'historique pour éviter une utilisation excessive de la mémoire

    // Fonction centrale pour afficher un panneau de contenu principal et gérer l'historique
    function showPanel(panelId, addToHistory = true) {
        hideAllContentPanels(); // Cache d'abord tous les panneaux de contenu principaux

        const panelToShow = document.getElementById(panelId);
        if (panelToShow) {
            panelToShow.style.display = 'block';
        } else {
            console.warn(`Panneau principal avec l'ID '${panelId}' non trouvé.`);
            return; // Sortir si le panneau n'existe pas
        }

        if (addToHistory) {
            // Empêche d'ajouter le même panneau plusieurs fois s'il est déjà le dernier
            if (panelHistory.length === 0 || panelHistory[panelHistory.length - 1] !== panelId) {
                panelHistory.push(panelId);
                // Réduire l'historique s'il devient trop long
                if (panelHistory.length > MAX_HISTORY_SIZE) {
                    panelHistory.shift(); // Supprime l'entrée la plus ancienne
                }
            }
        }
    }

    // Fonction pour fermer toute modale actuellement ouverte
    function closeOpenModal() {
        const modals = document.querySelectorAll('.modal-overlay');
        let modalClosed = false;
        modals.forEach(modal => {
            if (modal.style.display === 'flex') { // Les modales sont affichées avec 'flex'
                modal.style.display = 'none';
                modalClosed = true;
            }
        });
        return modalClosed; // Renvoie true si une modale a été fermée, false sinon
    }

    // Fonction pour revenir en arrière dans l'historique ou fermer une modale
    function goBack() {
        if (closeOpenModal()) { return; } // Une modale a été fermée, on s'arrête là.
        if (panelHistory.length > 1) {
            panelHistory.pop(); // Supprime le panneau actuel de l'historique
            const previousPanelId = panelHistory[panelHistory.length - 1]; // Récupère l'ID du panneau précédent
            showPanel(previousPanelId, false); // L'affiche, mais sans l'ajouter à nouveau à l'historique
        } else { showPanel('accueil-section', false); } // Si l'historique est vide ou n'a qu'un seul élément, on va à l'accueil
    }

    // --- Logique de la nouvelle facture ---
    let factureActuelle = { clientId: null, lignes: [], tvaTaux: 0.20 };

    function afficherFormulaireNouvelleFacture() { // F2 - Nouvelle facture
        showPanel('nouvelle-facture-form');
        // Réinitialiser l'état de la facture
        factureActuelle = { clientId: null, lignes: [], tvaTaux: 0.20 };
        document.getElementById('facture-client-details').style.display = 'none';
        document.getElementById('facture-client-recherche-container').style.display = 'block';
        document.getElementById('facture-recherche-client').value = '';
        document.getElementById('facture-lignes-table').getElementsByTagName('tbody')[0].innerHTML = '';
        document.getElementById('facture-infos-complementaires').value = '';

        // Générer un numéro de facture et la date
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        document.getElementById('facture-numero').innerText = `${year}${month}-${now.getTime().toString().slice(-4)}`;
        document.getElementById('facture-date').innerText = `${day}/${month}/${year}`;
        calculerTotaux();
    }

    function rechercherClientPourFacture() {
        const searchTerm = document.getElementById('facture-recherche-client').value;
        if (searchTerm.length < 2) {
            alert("Veuillez entrer au moins 2 caractères pour rechercher.");
            return;
        }

        const resultsContainer = document.getElementById('resultats-recherche-client-facture');

        fetch(`http://127.0.0.1:5000/api/clients/search?q=${searchTerm}`)
            .then(response => response.json())
            .then(clients => {
                resultsContainer.innerHTML = '';
                if (clients.length === 0) {
                    resultsContainer.innerHTML = '<p>Aucun client trouvé.</p>';
                } else {
                    clients.forEach(client => {
                        const bloc = document.createElement("div");
                        bloc.className = "client-card"; // On réutilise le style de la fiche client
                        bloc.innerHTML = `
                          <p><strong>Nom :</strong> ${client.nom} ${client.prenom || ''}</p>
                          <p><strong>Adresse :</strong> ${client.adresse || 'N/A'}</p>
                          <p><strong>Ville :</strong> ${client.code_postal || ''} ${client.ville || ''}</p>
                          <p><strong>Téléphone :</strong> ${client.telephone || 'N/A'}</p>
                        `;
                        const selectButton = document.createElement('button');
                        selectButton.innerText = 'Sélectionner ce client';
                        selectButton.onclick = () => selectionnerClientPourFacture(client);
                        bloc.appendChild(selectButton);
                        resultsContainer.appendChild(bloc);
                    });
                }
                // Afficher la modale
                document.getElementById('recherche-client-facture-panel').style.display = 'flex';
            }).catch(error => console.error("Erreur de recherche client:", error));
    }

    function selectionnerClientPourFacture(client) {
        factureActuelle.clientId = client.id;
        const detailsContainer = document.getElementById('facture-client-details');
        detailsContainer.innerHTML = `
            <strong>${client.nom} ${client.prenom || ''}</strong><br>
            ${client.adresse || ''}<br>
            ${client.code_postal || ''} ${client.ville || ''}<br>
            Tél: ${client.telephone || 'N/A'}
        `;
        detailsContainer.style.display = 'block';
        document.getElementById('facture-recherche-client').value = '';
        document.getElementById('facture-client-recherche-container').style.display = 'none';

        // Fermer la modale de recherche
        fermerRechercheClientFacture();
    }

    function fermerRechercheClientFacture() {
        document.getElementById('recherche-client-facture-panel').style.display = 'none';
    }

    function ajouterLigne(description, quantite, prix_unitaire_ht, piece_id = null) {
        // Ajoute la ligne à l'état de la facture actuelle
        factureActuelle.lignes.push({ id: Date.now(), description, quantite, prix_unitaire_ht, piece_id });
        // Met à jour l'affichage
        redessinerLignesFacture();
    }

    function redessinerLignesFacture() {
        const tbody = document.getElementById('facture-lignes-table').getElementsByTagName('tbody')[0];
        tbody.innerHTML = '';
        factureActuelle.lignes.forEach(ligne => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${ligne.description}</td><td>${ligne.quantite}</td>
                <td>${ligne.prix_unitaire_ht.toFixed(2)}</td><td>${(ligne.quantite * ligne.prix_unitaire_ht).toFixed(2)}</td>
                <td><button onclick="supprimerLigneFacture(${ligne.id})">X</button></td>
            `;
            tbody.appendChild(tr);
        });
        calculerTotaux();
    }

    function supprimerLigneFacture(ligneId) {
        factureActuelle.lignes = factureActuelle.lignes.filter(l => l.id !== ligneId);
        redessinerLignesFacture();
    }

    function calculerTotaux() {
        const totalHT = factureActuelle.lignes.reduce((sum, l) => sum + (l.quantite * l.prix_unitaire_ht), 0);
        const tva = totalHT * factureActuelle.tvaTaux;
        const totalTTC = totalHT + tva;
        document.getElementById('facture-total-ht').innerText = totalHT.toFixed(2);
        document.getElementById('facture-tva').innerText = tva.toFixed(2);
        document.getElementById('facture-total-ttc').innerText = totalTTC.toFixed(2);
    }

    function ajouterLignePiece() {
        // Ouvre le panneau de recherche de pièce
        document.getElementById('recherche-piece-facture-panel').style.display = 'flex';
        document.getElementById('recherche-piece-facture-input').focus();
    }

    function fermerRecherchePieceFacture() {
        document.getElementById('recherche-piece-facture-panel').style.display = 'none';
        document.getElementById('recherche-piece-facture-input').value = '';
        document.getElementById('resultats-recherche-piece-facture').innerHTML = '';
    }

    function rechercherPiecePourFacture() {
        const searchTerm = document.getElementById('recherche-piece-facture-input').value;
        const resultsContainer = document.getElementById('resultats-recherche-piece-facture');
        if (searchTerm.length < 2) {
            resultsContainer.innerHTML = '';
            return;
        }

        fetch(`http://127.0.0.1:5000/api/pieces/search?q=${searchTerm}`)
            .then(response => response.json())
            .then(pieces => {
                resultsContainer.innerHTML = '';
                pieces.forEach(piece => {
                    const div = document.createElement('div');
                    div.className = 'resultat-recherche-facture-item';
                    div.innerHTML = `
                        <strong>${piece.designation}</strong> (Réf: ${piece.ref || 'N/A'})<br>
                        <span>Prix de vente: ${piece.prix_vente.toFixed(2)} € HT</span>
                    `;
                    div.onclick = () => selectionnerPiecePourFacture(piece);
                    resultsContainer.appendChild(div);
                });
            }).catch(error => console.error("Erreur de recherche de pièce:", error));
    }

    function selectionnerPiecePourFacture(piece) {
        const quantite = parseFloat(prompt(`Quantité pour "${piece.designation}" ?`, "1"));
        if (quantite && !isNaN(quantite) && quantite > 0) {
            ajouterLigne(`${piece.designation} (Réf: ${piece.ref || 'N/A'})`, quantite, piece.prix_vente, piece.id);
            fermerRecherchePieceFacture();
        }
    }

    function ajouterLigneMainDoeuvre() {
        // Ouvre le panneau de recherche de main d'oeuvre
        document.getElementById('recherche-maindoeuvre-facture-panel').style.display = 'flex';
        document.getElementById('recherche-maindoeuvre-facture-input').focus();
    }

    function fermerRechercheMainDoeuvreFacture() {
        document.getElementById('recherche-maindoeuvre-facture-panel').style.display = 'none';
        document.getElementById('recherche-maindoeuvre-facture-input').value = '';
        document.getElementById('resultats-recherche-maindoeuvre-facture').innerHTML = '';
    }

    function rechercherMainDoeuvrePourFacture() {
        const searchTerm = document.getElementById('recherche-maindoeuvre-facture-input').value;
        const resultsContainer = document.getElementById('resultats-recherche-maindoeuvre-facture');
        if (searchTerm.length < 2) {
            resultsContainer.innerHTML = '';
            return;
        }

        fetch(`http://127.0.0.1:5000/api/maindoeuvre/search?q=${searchTerm}`)
            .then(response => response.json())
            .then(items => {
                resultsContainer.innerHTML = '';
                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'resultat-recherche-facture-item';
                    div.innerHTML = `
                        <strong>${item.description}</strong><br>
                        <span>Taux horaire: ${item.taux_horaire.toFixed(2)} € HT</span>
                    `;
                    div.onclick = () => selectionnerMainDoeuvrePourFacture(item);
                    resultsContainer.appendChild(div);
                });
            }).catch(error => console.error("Erreur de recherche de main d'oeuvre:", error));
    }

    function selectionnerMainDoeuvrePourFacture(item) {
        const quantite = parseFloat(prompt(`Nombre d'heures pour "${item.description}" ?`, "1"));
        if (quantite && !isNaN(quantite) && quantite > 0) {
            ajouterLigne(item.description, quantite, item.taux_horaire);
            fermerRechercheMainDoeuvreFacture();
        }
    }

    function sauvegarderFacture() {
        if (!factureActuelle.clientId) { alert("Veuillez sélectionner un client."); return; }
        if (factureActuelle.lignes.length === 0) { alert("Veuillez ajouter au moins une ligne à la facture."); return; }

        const data_a_envoyer = {
            numero_facture: document.getElementById('facture-numero').innerText,
            client_id: factureActuelle.clientId,
            informations_complementaires: document.getElementById('facture-infos-complementaires').value,
            lignes: factureActuelle.lignes.map(l => ({
                description: l.description,
                quantite: l.quantite,
                prix_unitaire_ht: l.prix_unitaire_ht,
                piece_id: l.piece_id
            }))
        };

        console.log("Tentative de sauvegarde avec les données suivantes :", JSON.stringify(data_a_envoyer, null, 2));

        fetch("http://127.0.0.1:5000/api/factures", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data_a_envoyer)
        })
        .then(response => {
            console.log("Réponse brute du serveur reçue. Statut:", response.status);
            if (!response.ok) {
                // Si la réponse n'est pas OK, on essaie de lire le texte de l'erreur
                return response.text().then(text => { 
                    throw new Error(`Erreur du serveur (statut ${response.status}): ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log("Données JSON analysées avec succès:", data);
            alert(data.message || "Facture sauvegardée avec succès !");
            
            if (data.facture && data.facture.id) {
                const factureId = data.facture.id;
                document.getElementById('facture-actions-initiales').style.display = 'none';
                document.getElementById('facture-actions-post-sauvegarde').style.display = 'block';
                document.getElementById('btn-imprimer-pdf').onclick = () => imprimerFacture(factureId);
            } else {
                console.error("La réponse du serveur ne contient pas l'ID de la facture.", data);
                alert("La facture a été sauvegardée, mais une erreur est survenue lors de la récupération de son ID. Le bouton PDF ne sera pas disponible.");
            }
        })
        .catch(error => {
            console.error("Erreur détaillée lors de la sauvegarde de la facture:", error);
            alert(`Une erreur est survenue lors de la sauvegarde : ${error.message}. Vérifiez la console pour plus de détails.`);
        });
    }

    function imprimerFacture(factureId) { window.open(`http://127.0.0.1:5000/api/factures/${factureId}/pdf`); }

    function afficherInterfaceFactures() {
      showPanel('facture-options'); // F2 - Factures
    }

    function afficherFormulaireRechercheFacture() {
        showPanel('recherche-facture-form'); // F2 - Recherche de facture
        document.getElementById('resultats-recherche-factures').innerHTML = ''; // Vider les anciens résultats
        document.getElementById('recherche-facture-input').focus();
    }

    function rechercherFacture() {
        const searchTerm = document.getElementById('recherche-facture-input').value;
        if (searchTerm.length < 2) {
            alert("Veuillez entrer au moins 2 caractères pour la recherche.");
            return;
        }

        fetch(`http://127.0.0.1:5000/api/factures/search?q=${searchTerm}`)
            .then(response => {
                if (!response.ok) throw new Error('Erreur réseau lors de la recherche.');
                return response.json();
            })
            .then(factures => {
                afficherResultatsFactures(factures);
            })
            .catch(error => {
                console.error("Erreur lors de la recherche de factures:", error);
                document.getElementById('resultats-recherche-factures').innerHTML = `<p>Une erreur est survenue.</p>`;
            });
    }

    function afficherResultatsFactures(factures) {
        const container = document.getElementById('resultats-recherche-factures');
        container.innerHTML = '';

        if (!factures || factures.length === 0) {
            container.innerHTML = '<p>Aucune facture trouvée pour votre recherche.</p>';
        } else {
            factures.forEach(facture => {
                const bloc = document.createElement('div');
                bloc.className = 'client-card'; // On réutilise le style des fiches
                const clientPrenom = facture.client.prenom || ''; // Gestion du prénom potentiellement absent
                const clientNom = facture.client.nom || '';
                const dateCreation = new Date(facture.date_creation).toLocaleDateString('fr-FR');
                bloc.innerHTML = `
                    <h4>Facture N° ${facture.numero_facture}</h4>
                    <p><strong>Client :</strong> ${clientPrenom.trim()} ${clientNom.trim()}</p>
                    <p><strong>Date :</strong> ${dateCreation}</p>
                    <p><strong>Total TTC :</strong> ${facture.total_ttc.toFixed(2)} €</p>
                    <button onclick="imprimerFacture(${facture.id})">Imprimer PDF</button>
                `;
                container.appendChild(bloc);
            });
        }
        container.style.display = 'block';
    }

    function afficherOptionsClient() { showPanel('client-options'); } // F3 - Clients
    function afficherFormulaireNouveauClient() { // F3 - Nouveau client
      showPanel('nouveau-client-form');
      // Vider le formulaire à chaque affichage pour une nouvelle saisie
      document.getElementById('nouveau-client-form').querySelectorAll('input').forEach(input => input.value = '');
    }
    function afficherFormulaireNouvellePiece() { showPanel('nouveau-piece-form');  } // F4 - Nouvelle référence
    function afficherFormulaireRecherchePiece() { showPanel('recherche-piece-form'); document.getElementById('resultats-recherche-pieces').innerHTML = ''; } // F4 - Référence connue

    // --- Fonctions de navigation entre les onglets ---

    function afficherInterfacePieces(){
      showPanel('interface-pieces'); // F4 - Pièces
    }

    function afficherAccueil() {
      showPanel('accueil-section'); // F1 - Accueil
    }

    // Fonctions vides pour éviter les erreurs sur les onglets non implémentés
    function afficherInterfaceMaindoeuvre() {
      showPanel('interface-maindoeuvre'); // F5 - Main d'oeuvre
    }

    function afficherInterfaceAnalyse() { alert("Section 'Analyse' non implémentée."); }
    function afficherInterfacePhotos() { alert("Section 'Photos' non implémentée."); }

    // --- GESTION DES CLIENTS (ONGLET 2) - VERSION AMÉLIORÉE ---

    function afficherFormulaireRechercheClient() { // F3 - Client déjà existant
        showPanel('recherche-client-form');
        document.getElementById('resultatsRecherche').style.display = 'block';
        document.getElementById('recherche-client-input').value = '';
        rechercherClient(); // Lance une recherche initiale pour afficher tous les clients
    }

    function rechercherClient() {
        const searchTerm = document.getElementById("recherche-client-input").value;
        // Note: L'API backend doit être adaptée pour gérer une recherche GET sur /api/clients/search?q=...
        fetch(`http://127.0.0.1:5000/api/clients/search?q=${encodeURIComponent(searchTerm)}`)
            .then(response => {
                if (!response.ok) throw new Error(`Erreur réseau: ${response.statusText}`);
                return response.json();
            })
            .then(clients => {
                afficherResultatsClients(clients);
            })
            .catch(error => {
                console.error("Erreur lors de la recherche de client:", error);
                document.getElementById("resultatsRecherche").innerHTML = `<p class="error">Erreur lors de la récupération des clients.</p>`;
            });
    }

    function afficherResultatsClients(clients) {
        const container = document.getElementById("resultatsRecherche");
        container.innerHTML = "";

        if (!clients || clients.length === 0) {
            container.innerHTML = "<p>Aucun client trouvé.</p>";
            return;
        }

        clients.forEach(client => {
            const bloc = document.createElement("div");
            bloc.className = "client-card";
            bloc.innerHTML = `
              <p><strong>Nom :</strong> ${client.nom || ''} ${client.prenom || ''}</p>
              <p><strong>Téléphone :</strong> ${client.telephone || 'N/A'}</p>
              <p><strong>Email :</strong> ${client.email || 'N/A'}</p>
              <p><strong>Adresse :</strong> ${client.adresse || ''}, ${client.code_postal || ''} ${client.ville || ''}</p>
              <button onclick='ouvrirModalModificationClient(${JSON.stringify(client)})'>Modifier</button>
              <button onclick="supprimerClient(${client.id})">Supprimer</button>
            `;
            container.appendChild(bloc);
        });
    }

    function ouvrirModalModificationClient(client) {
        document.getElementById('edit-client-id').value = client.id;
        document.getElementById('edit-nom').value = client.nom || '';
        document.getElementById('edit-prenom').value = client.prenom || '';
        document.getElementById('edit-telephone').value = client.telephone || '';
        document.getElementById('edit-email').value = client.email || '';
        document.getElementById('edit-adresse').value = client.adresse || '';
        document.getElementById('edit-code_postal').value = client.code_postal || '';
        document.getElementById('edit-ville').value = client.ville || '';
        document.getElementById('edit-pays').value = client.pays || '';
        document.getElementById('edit-client-modal').style.display = 'flex';
    }

    function fermerModalModificationClient() {
        document.getElementById('edit-client-modal').style.display = 'none';
    }

    function enregistrerModificationClient() {
        const clientId = document.getElementById("edit-client-id").value;
        const clientData = {
            nom: document.getElementById("edit-nom").value,
            prenom: document.getElementById("edit-prenom").value,
            telephone: document.getElementById("edit-telephone").value,
            email: document.getElementById("edit-email").value,
            adresse: document.getElementById("edit-adresse").value,
            code_postal: document.getElementById("edit-code_postal").value,
            ville: document.getElementById("edit-ville").value,
            pays: document.getElementById("edit-pays").value
        };

        fetch(`http://127.0.0.1:5000/api/clients/${clientId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(clientData)
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            fermerModalModificationClient();
            rechercherClient(); // Rafraîchit la liste pour afficher les modifications
        })
        .catch(error => console.error("Erreur lors de la modification:", error));
    }

    function ajouterClient() {
        const client = {
            nom: document.getElementById("nom").value,
            prenom: document.getElementById("prenom").value,
            telephone: document.getElementById("telephone").value,
            email: document.getElementById("email").value,
            adresse: document.getElementById("adresse").value,
            code_postal: document.getElementById("code_postal").value,
            ville: document.getElementById("ville").value,
            pays: document.getElementById("pays").value
        };

        fetch("http://127.0.0.1:5000/api/clients", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(client)
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            afficherFormulaireRechercheClient(); // Revenir à la liste des clients et la rafraîchir
        })
        .catch(error => console.error("Erreur:", error));
    }

    function supprimerClient(id) {
        if (!confirm("Confirmer la suppression de ce client ? Cette action est irréversible.")) return;
        fetch(`http://127.0.0.1:5000/api/clients/${id}`, {
            method: "DELETE"
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            rechercherClient(); // Rafraîchit la liste après la suppression
        })
        .catch(error => console.error("Erreur:", error));
    }

    // --- Fonctions de gestion des données ---

    function ajouterPiece() {
      const piece = {
        designation: document.getElementById('piece-designation').value,
        ref: document.getElementById('piece-ref').value, // "ref" est un bon nom de clé
        prix_achat: document.getElementById('piece-prix-achat').value, // J'utilise prix_achat pour être cohérent avec le style Python
        prix_vente: document.getElementById('piece-prix-vente').value  // Idem pour prix_vente
      };

      fetch("http://127.0.0.1:5000/api/pieces", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(piece)
      })
      .then(response => response.json())
      .then(data => {
        alert(data.message || "Pièce ajoutée avec succès !");
        // Correction: .reset() ne fonctionne que sur les <form>, on vide les champs manuellement.
        document.getElementById('piece-designation').value = '';
        document.getElementById('piece-ref').value = '';
        document.getElementById('piece-prix-achat').value = '';
        document.getElementById('piece-prix-vente').value = '';
        afficherInterfacePieces(); // Revenir à l'écran principal des pièces
      })
      .catch(error => console.error("Erreur lors de l'ajout de la pièce:", error));
    }

    function rechercherPiece() {
      const designation = document.getElementById('recherche-piece-designation').value;
      const ref = document.getElementById('recherche-piece-ref').value;

      fetch("http://127.0.0.1:5000/api/pieces/search", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ designation, ref })
      })
      .then(response => response.json())
      .then(data => afficherResultatsPieces(data.pieces))
      .catch(error => console.error("Erreur lors de la recherche de pièces:", error));
    }

    function afficherResultatsPieces(pieces) {
      const container = document.getElementById("resultats-recherche-pieces");
      container.innerHTML = ""; // Vider les anciens résultats
      document.getElementById('recherche-piece-form').style.display = 'block'; // Garder le formulaire de recherche visible

      if (!pieces || pieces.length === 0) {
          container.innerHTML = "<p>Aucune pièce trouvée.</p>";
      } else {
          pieces.forEach(piece => {
              const bloc = document.createElement("div");
              bloc.className = "client-card"; // On réutilise le même style
              bloc.innerHTML = `
                  <p><strong>Désignation :</strong> ${piece.designation}</p>
                  <p><strong>Référence :</strong> ${piece.ref || 'N/A'}</p>
                  <p><strong>Prix Achat HT :</strong> ${piece.prix_achat !== null ? piece.prix_achat.toFixed(2) + ' €' : 'N/A'}</p>
                  <p><strong>Prix Vente HT :</strong> ${piece.prix_vente.toFixed(2)} €</p>
              `;
              container.appendChild(bloc);
          });
      }
      container.style.display = "block";
    }

    function testerBackendPieces() {
     fetch("http://127.0.0.1:5000/api/pieces")
    .then(response => response.json())
    .then(data => alert("Réponse backend : " + data.message))
    .catch(error => alert("Erreur de connexion au backend : " + error));
}

    // --- NOUVEAU: Fonctions pour la Main d'oeuvre ---

    function afficherFormulaireNouvelleMainDoeuvre() { showPanel('nouveau-maindoeuvre-form'); } // F5 - Nouveau type
    function afficherFormulaireRechercheMainDoeuvre() { showPanel('recherche-maindoeuvre-form'); document.getElementById('resultats-recherche-maindoeuvre').innerHTML = ''; } // F5 - Rechercher un type

    function ajouterMainDoeuvre() {
      const maindoeuvre = {
        description: document.getElementById('maindoeuvre-description').value,
        taux_horaire: document.getElementById('maindoeuvre-taux-horaire').value
      };

      if (!maindoeuvre.description || !maindoeuvre.taux_horaire) {
        alert("La description et le taux horaire sont obligatoires.");
        return;
      }

      fetch("http://127.0.0.1:5000/api/maindoeuvre", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(maindoeuvre)
      })
      .then(response => {
        // Gère les réponses d'erreur du serveur (comme les doublons)
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.message) });
        }
        return response.json();
      })
      .then(data => {
        alert(data.message || "Type de main d'oeuvre ajouté avec succès !");
        // Correction: .reset() ne fonctionne que sur les <form>, on vide les champs manuellement.
        document.getElementById('maindoeuvre-description').value = '';
        document.getElementById('maindoeuvre-taux-horaire').value = '';
        // Vider le champ de recherche pour s'assurer d'afficher tous les résultats
        document.getElementById('recherche-maindoeuvre-description').value = '';
        // Lancer une recherche pour rafraîchir la liste et l'afficher
        rechercherMainDoeuvre();
      })
      .catch(error => {
          console.error("Erreur lors de l'ajout de la main d'oeuvre:", error);
          alert(error.message); // Affiche le message d'erreur spécifique à l'utilisateur
      });
    }

    function rechercherMainDoeuvre() {
      const description = document.getElementById('recherche-maindoeuvre-description').value;
      fetch("http://127.0.0.1:5000/api/maindoeuvre/search", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ description })
      })
      .then(response => response.json())
      .then(data => afficherResultatsMainDoeuvre(data.maindoeuvre))
      .catch(error => console.error("Erreur lors de la recherche de main d'oeuvre:", error));
    }

    function afficherResultatsMainDoeuvre(items) {
      const container = document.getElementById("resultats-recherche-maindoeuvre");
      container.innerHTML = ""; // Vider les anciens résultats
      document.getElementById('recherche-maindoeuvre-form').style.display = 'block';

      if (!items || items.length === 0) {
          container.innerHTML = "<p>Aucun type de main d'oeuvre trouvé.</p>";
      } else {
          items.forEach(item => {
              const bloc = document.createElement("div");
              bloc.className = "client-card";
              bloc.innerHTML = `
                <p><strong>Description :</strong> ${item.description}</p>
                <p><strong>Taux horaire HT :</strong> ${item.taux_horaire.toFixed(2)} €</p>
                <button onclick="supprimerMainDoeuvre(${item.id})">Supprimer</button>
                <button onclick='modifierMainDoeuvre(${JSON.stringify(item)})'>Modifier</button>
              `;
              container.appendChild(bloc);
          });
      }
      container.style.display = "block";
    }

    function supprimerMainDoeuvre(id) {
        if (!confirm("Confirmer la suppression de ce type de main d'oeuvre ?")) return;
        fetch(`http://127.0.0.1:5000/api/maindoeuvre/${id}`, {
            method: "DELETE"
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.message) });
            }
            return response.json();
        })
        .then(data => {
            alert(data.message);
            rechercherMainDoeuvre(); // Rafraîchit la liste
        })
        .catch(error => {
            console.error("Erreur lors de la suppression:", error);
            alert(error.message);
        });
    }

    function modifierMainDoeuvre(item) {
        const container = document.getElementById("resultats-recherche-maindoeuvre");
        container.innerHTML = ""; // Vide les résultats précédents

        const form = document.createElement("div");
        form.className = "client-card";
        form.innerHTML = `
          <h3>Modifier le type de main d'oeuvre</h3>
          <div class="form-group">
            <label for="edit-maindoeuvre-description">Description</label>
            <input type="text" id="edit-maindoeuvre-description" value="${item.description}">
          </div>
          <div class="form-group">
            <label for="edit-maindoeuvre-taux">Taux horaire HT</label>
            <input type="number" id="edit-maindoeuvre-taux" value="${item.taux_horaire.toFixed(2)}" step="0.01">
          </div>
          <button onclick="enregistrerModificationMainDoeuvre(${item.id})">Enregistrer</button>
          <button onclick="rechercherMainDoeuvre()">Annuler</button>
        `;
        container.appendChild(form);
    }

    function enregistrerModificationMainDoeuvre(id) {
        const data = {
            description: document.getElementById("edit-maindoeuvre-description").value,
            taux_horaire: document.getElementById("edit-maindoeuvre-taux").value
        };

        if (!data.description || !data.taux_horaire) {
            alert("La description et le taux horaire sont obligatoires.");
            return;
        }

        fetch(`http://127.0.0.1:5000/api/maindoeuvre/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.message) });
            }
            return response.json();
        })
        .then(data => {
            alert(data.message);
            rechercherMainDoeuvre(); // Rafraîchit la liste
        })
        .catch(error => {
            console.error("Erreur lors de la modification:", error);
            alert(error.message);
        });
    }

    function afficherInterfaceOptions() { alert("Section 'Options' non implémentée."); } // F8 - Options

    // --- GESTION DES RACCOURCIS CLAVIER (F1, F2, etc.) ---
    document.addEventListener('keydown', function(event) {
        // On utilise un switch pour gérer les différentes touches
        switch (event.key) {
            case 'F1':
                event.preventDefault(); // Empêche l'action par défaut du navigateur (ouvrir l'aide)
                afficherAccueil();
                break;
            case 'F2':
                event.preventDefault();
                afficherInterfaceFactures();
                break;
            case 'F3':
                event.preventDefault();
                afficherOptionsClient();
                break;
            case 'F4':
                event.preventDefault();
                afficherInterfacePieces();
                break;
            case 'F5':
                event.preventDefault();
                afficherInterfaceMaindoeuvre();
                break;
            case 'F6': event.preventDefault(); afficherInterfaceAnalyse(); break;
            case 'F7': event.preventDefault(); afficherInterfacePhotos(); break;
            case 'F8': event.preventDefault(); afficherInterfaceOptions(); break;
            case 'Escape': goBack(); break; // Utilise 'Escape' pour la touche Échap
        }
    });

  // Afficher l'accueil au chargement de la page
  window.onload = afficherAccueil;
</script>

</body>
</html>
